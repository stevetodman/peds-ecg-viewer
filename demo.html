<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUSE - ECG Management System</title>
  <link rel="stylesheet" href="./src/muse.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="muse-app">
    <!-- Title Bar -->
    <div class="title-bar">
      <div class="title-bar-left">
        <div class="title-bar-icon"></div>
        <span class="title-bar-text">MUSE - ECG Management System - <span id="title-patient">DOE, JANE</span> - <span id="title-datetime">12/20/2025, 4:04:01 PM</span></span>
      </div>
      <div class="title-bar-buttons">
        <button class="title-btn" title="Minimize">_</button>
        <button class="title-btn" title="Maximize">‚òê</button>
        <button class="title-btn" title="Close">‚úï</button>
      </div>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar">
      <div class="menu-item" data-menu="system">
        <u>S</u>ystem
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="edit-list">Edit List<span class="shortcut">F2</span></div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="exit">Exit</div>
        </div>
      </div>
      <div class="menu-item" data-menu="go">
        <u>G</u>o
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="go-back">Back to Edit List</div>
          <div class="dropdown-item" data-action="go-next">Next ECG</div>
          <div class="dropdown-item" data-action="go-prev">Previous ECG</div>
        </div>
      </div>
      <div class="menu-item" data-menu="list">
        <u>L</u>ist
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="refresh-list">Refresh List</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="my-inbasket">My In-Basket</div>
          <div class="dropdown-item" data-action="peds-physician">Pediatric Physician</div>
          <div class="dropdown-item" data-action="recent-edits">My Recent Edits</div>
        </div>
      </div>
      <div class="menu-item" data-menu="file">
        <u>F</u>ile
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="open">Open...<span class="shortcut">Ctrl+O</span></div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="save">Save<span class="shortcut">Ctrl+S</span></div>
          <div class="dropdown-item" data-action="save-as">Save As...</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="print">Print...<span class="shortcut">Ctrl+P</span></div>
          <div class="dropdown-item" data-action="export-pdf">Export PDF...</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="exit">Exit</div>
        </div>
      </div>
      <div class="menu-item" data-menu="edit">
        <u>E</u>dit
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="undo">Undo<span class="shortcut">Ctrl+Z</span></div>
          <div class="dropdown-item" data-action="redo">Redo<span class="shortcut">Ctrl+Y</span></div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="cut">Cut<span class="shortcut">Ctrl+X</span></div>
          <div class="dropdown-item" data-action="copy">Copy<span class="shortcut">Ctrl+C</span></div>
          <div class="dropdown-item" data-action="paste">Paste<span class="shortcut">Ctrl+V</span></div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="select-all">Select All<span class="shortcut">Ctrl+A</span></div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="patient-info">Patient Information...</div>
        </div>
      </div>
      <div class="menu-item" data-menu="view">
        <u>V</u>iew
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="zoom-in">Zoom In<span class="shortcut">Ctrl++</span></div>
          <div class="dropdown-item" data-action="zoom-out">Zoom Out<span class="shortcut">Ctrl+-</span></div>
          <div class="dropdown-item" data-action="fit-window">Fit to Window</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="toggle-grid"><span class="checkmark">‚úì</span>Show Grid</div>
          <div class="dropdown-item" data-action="toggle-annotations"><span class="checkmark"></span>Show Interval Annotations</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="format-12">12-Lead Format</div>
          <div class="dropdown-item" data-action="format-15"><span class="checkmark">‚úì</span>15-Lead Pediatric Format</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="speed-25"><span class="checkmark">‚úì</span>Paper Speed: 25 mm/s</div>
          <div class="dropdown-item" data-action="speed-50">Paper Speed: 50 mm/s</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="gain-5">Gain: 5 mm/mV</div>
          <div class="dropdown-item" data-action="gain-10"><span class="checkmark">‚úì</span>Gain: 10 mm/mV</div>
          <div class="dropdown-item" data-action="gain-20">Gain: 20 mm/mV</div>
        </div>
      </div>
      <div class="menu-item" data-menu="ecg">
        ECG
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="acquire-ecg">Acquire ECG...</div>
          <div class="dropdown-item" data-action="analyze">Analyze ECG</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="confirm-interp">Confirm Interpretation</div>
          <div class="dropdown-item" data-action="reject-interp">Reject Interpretation</div>
          <div class="dropdown-item" data-action="edit-interp">Edit Interpretation...</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="measurements-tab">Measurements</div>
          <div class="dropdown-item" data-action="compare-ecgs">Compare ECGs...</div>
        </div>
      </div>
      <div class="menu-item" data-menu="reports">
        <u>R</u>eports
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="report-standard">Standard Report</div>
          <div class="dropdown-item" data-action="report-detailed">Detailed Report</div>
          <div class="dropdown-item" data-action="report-summary">Summary Report</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="report-custom">Custom Report...</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="patient-history">Patient History</div>
        </div>
      </div>
      <div class="menu-item" data-menu="tools">
        <u>T</u>ools
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="tool-calipers">Calipers (Time/Rate)</div>
          <div class="dropdown-item" data-action="tool-amplitude">Amplitude Calipers</div>
          <div class="dropdown-item" data-action="clear-measurements">Clear Measurements</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="tool-zoom-region">Zoom Region</div>
          <div class="dropdown-item" data-action="tool-pan">Pan</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="settings">Settings...</div>
        </div>
      </div>
      <div class="menu-item" data-menu="window">
        <u>W</u>indow
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="win-cascade">Cascade</div>
          <div class="dropdown-item" data-action="win-tile-h">Tile Horizontally</div>
          <div class="dropdown-item" data-action="win-tile-v">Tile Vertically</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="win-minimize">Minimize All</div>
          <div class="dropdown-item" data-action="win-maximize">Maximize</div>
          <div class="dropdown-item" data-action="win-close">Close</div>
        </div>
      </div>
      <div class="menu-item" data-menu="help">
        <u>H</u>elp
        <div class="dropdown-menu">
          <div class="dropdown-item" data-action="help-contents">Help Contents<span class="shortcut">F1</span></div>
          <div class="dropdown-item" data-action="user-guide">User Guide</div>
          <div class="dropdown-item" data-action="quick-start">Quick Start Tutorial</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item" data-action="about">About GEMUSE...</div>
        </div>
      </div>
    </div>

    <!-- Main Toolbar -->
    <div class="toolbar">
      <button class="toolbar-btn" id="btn-open" title="Open (Ctrl+O)">
        <span class="icon">üìÇ</span>
        <span class="label">Open</span>
      </button>
      <button class="toolbar-btn" id="btn-save" title="Save (Ctrl+S)">
        <span class="icon">üíæ</span>
        <span class="label">Save</span>
      </button>
      <div class="toolbar-separator"></div>
      <button class="toolbar-btn" id="btn-print" title="Print (Ctrl+P)">
        <span class="icon">üñ®</span>
        <span class="label">Print</span>
      </button>
      <button class="toolbar-btn" id="btn-pdf" title="Export PDF">
        <span class="icon">üìÑ</span>
        <span class="label">PDF</span>
      </button>
      <div class="toolbar-separator"></div>
      <button class="toolbar-btn" id="btn-prev" title="Previous ECG">
        <span class="icon">‚óÄ</span>
        <span class="label">Prev</span>
      </button>
      <button class="toolbar-btn" id="btn-next" title="Next ECG">
        <span class="icon">‚ñ∂</span>
        <span class="label">Next</span>
      </button>
      <div class="toolbar-separator"></div>
      <button class="toolbar-btn" id="btn-zoom-in" title="Zoom In">
        <span class="icon">üîç</span>
        <span class="label">Zoom+</span>
      </button>
      <button class="toolbar-btn" id="btn-zoom-out" title="Zoom Out">
        <span class="icon">üîé</span>
        <span class="label">Zoom-</span>
      </button>
      <button class="toolbar-btn" id="btn-refresh" title="New ECG">
        <span class="icon">üîÑ</span>
        <span class="label">New</span>
      </button>
      <button class="toolbar-btn" id="btn-sample-ecg" title="Load Sample ECG Image (Test PNG Digitizer)" style="background: #e8f5e9;">
        <span class="icon">üñºÔ∏è</span>
        <span class="label">Sample IMG</span>
      </button>
      <div class="toolbar-separator"></div>
      <select class="toolbar-select" id="format-select">
        <option value="12">12-Lead Standard</option>
        <option value="15" selected>15-Lead Pediatric</option>
      </select>
      <select class="toolbar-select" id="speed-select">
        <option value="25" selected>25 mm/s</option>
        <option value="50">50 mm/s</option>
      </select>
      <select class="toolbar-select" id="gain-select">
        <option value="5">5 mm/mV</option>
        <option value="10" selected>10 mm/mV</option>
        <option value="20">20 mm/mV</option>
      </select>
    </div>

    <!-- ========== EDIT LIST VIEW (Worklist) ========== -->
    <div class="view-container" id="view-edit-list">
      <div class="edit-list-header">
        <span class="edit-list-title">Edit List by Patient Name</span>
        <span class="edit-list-count">10 Items Matching <span id="edit-list-filter">Pediatric Physician</span></span>
      </div>
      <div class="edit-list-content">
        <!-- Left Panel - Options -->
        <div class="edit-list-options">
          <div class="options-header">
            Edit List Options
            <button class="options-close">‚úï</button>
          </div>
          <div class="options-section">
            <div class="options-section-header">
              Select Patient & Presets
              <span class="options-collapse">‚äñ</span>
            </div>
            <div class="options-section-body">
              <div class="options-label">Select Patient by ID</div>
              <input type="text" class="options-input" id="select-patient-id" placeholder="">
              <div class="options-label" style="margin-top:12px;">Presets</div>
              <div class="preset-item">
                <span class="preset-icon">üì•</span>
                My In-Basket
              </div>
              <div class="preset-item selected">
                <input type="checkbox" checked>
                Pediatric Physician
              </div>
              <div class="preset-item">
                <span class="preset-icon">üìù</span>
                My Recent Edits
              </div>
            </div>
          </div>
        </div>

        <!-- Main Table -->
        <div class="edit-list-table-container">
          <table class="edit-list-table">
            <thead>
              <tr>
                <th style="width:80px;">Patient ID</th>
                <th style="width:150px;">Name <span class="sort-arrow">‚ñ≤</span></th>
                <th style="width:70px;">Age</th>
                <th style="width:60px;">Year</th>
                <th style="width:90px;">Test Type</th>
                <th style="width:120px;">Department</th>
                <th style="width:180px;">Diagnosis</th>
                <th style="width:100px;">ECG ID</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody id="edit-list-tbody">
              <tr data-ecg-id="1001" onclick="selectECGRow(this)" ondblclick="openECG('1001')">
                <td>14823</td>
                <td>SMITH, EMMA</td>
                <td>2 Years</td>
                <td>12/20/2025 08:15</td>
                <td>ECG</td>
                <td>DR. JOHNSON</td>
                <td>Demographics complete</td>
                <td>V2024001</td>
                <td>Peds Cardiology</td>
              </tr>
              <tr data-ecg-id="1002" onclick="selectECGRow(this)" ondblclick="openECG('1002')">
                <td>16354</td>
                <td>GARCIA, SOFIA</td>
                <td>3 Months</td>
                <td>12/20/2025 08:22</td>
                <td>ECG</td>
                <td>DR. WILLIAMS</td>
                <td>Demographics complete</td>
                <td>V2024002</td>
                <td>NICU</td>
              </tr>
              <tr data-ecg-id="1003" onclick="selectECGRow(this)" ondblclick="openECG('1003')" class="selected">
                <td>14829</td>
                <td>JOHNSON, LIAM</td>
                <td>16 Years</td>
                <td>12/20/2025 08:30</td>
                <td>ECG</td>
                <td>DR. BROWN</td>
                <td>Demographics complete</td>
                <td>V2024003</td>
                <td>Peds Cardiology</td>
              </tr>
              <tr data-ecg-id="1004" onclick="selectECGRow(this)" ondblclick="openECG('1004')">
                <td>15001</td>
                <td>MARTINEZ, OLIVIA</td>
                <td>13 Years</td>
                <td>12/20/2025 08:45</td>
                <td>ECG</td>
                <td>DR. DAVIS</td>
                <td>Demographics complete</td>
                <td>V2024004</td>
                <td>Peds Clinic</td>
              </tr>
              <tr data-ecg-id="1005" onclick="selectECGRow(this)" ondblclick="openECG('1005')">
                <td>11245</td>
                <td>WILLIAMS, NOAH</td>
                <td>13 Years</td>
                <td>12/20/2025 09:00</td>
                <td>ECG</td>
                <td>DR. MILLER</td>
                <td>Demographics complete</td>
                <td>V2024005</td>
                <td>Peds Cardiology</td>
              </tr>
              <tr data-ecg-id="1006" onclick="selectECGRow(this)" ondblclick="openECG('1006')">
                <td>15234</td>
                <td>BROWN, AVA</td>
                <td>15 Years</td>
                <td>12/20/2025 09:15</td>
                <td>ECG</td>
                <td>DR. WILSON</td>
                <td>Demographics complete</td>
                <td>V2024006</td>
                <td>Peds Clinic</td>
              </tr>
              <tr data-ecg-id="1007" onclick="selectECGRow(this)" ondblclick="openECG('1007')">
                <td>16432</td>
                <td>JONES, ETHAN</td>
                <td>16 Years</td>
                <td>12/20/2025 09:30</td>
                <td>ECG</td>
                <td>DR. MOORE</td>
                <td>Demographics complete</td>
                <td>V2024007</td>
                <td>Sports Medicine</td>
              </tr>
              <tr data-ecg-id="1008" onclick="selectECGRow(this)" ondblclick="openECG('1008')">
                <td>14987</td>
                <td>DAVIS, MIA</td>
                <td>10 Years</td>
                <td>12/20/2025 09:45</td>
                <td>ECG</td>
                <td>DR. TAYLOR</td>
                <td>Demographics complete</td>
                <td>V2024008</td>
                <td>Peds Cardiology</td>
              </tr>
              <tr data-ecg-id="1009" onclick="selectECGRow(this)" ondblclick="openECG('1009')">
                <td>15321</td>
                <td>MILLER, JAMES</td>
                <td>13 Months</td>
                <td>12/20/2025 10:00</td>
                <td>ECG</td>
                <td>DR. ANDERSON</td>
                <td>Demographics complete</td>
                <td>V2024009</td>
                <td>PICU</td>
              </tr>
              <tr data-ecg-id="1010" onclick="selectECGRow(this)" ondblclick="openECG('1010')">
                <td>11765</td>
                <td>WILSON, CHARLOTTE</td>
                <td>17 Years</td>
                <td>12/20/2025 10:15</td>
                <td>ECG</td>
                <td>DR. THOMAS</td>
                <td>Demographics complete</td>
                <td>V2024010</td>
                <td>Peds Cardiology</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bottom Search Panel -->
      <div class="retrieval-panel">
        <div class="retrieval-header">
          Test/Order Retrieval List - No Current Search
          <button class="retrieval-close">‚úï</button>
        </div>
        <div class="retrieval-content">
          <div class="retrieval-tabs">
            <button class="retrieval-tab active">Test/Order</button>
            <button class="retrieval-tab">Patient</button>
          </div>
          <div class="retrieval-table-header">
            <span style="width:80px;">Patient ID</span>
            <span style="width:100px;">Name ‚ñ≤</span>
            <span style="width:50px;">Age</span>
            <span style="width:90px;">Date/Time</span>
            <span style="width:70px;">Test Type</span>
            <span style="width:60px;">Format</span>
            <span style="width:60px;">Status</span>
            <span style="width:100px;">Mismatch (Yes/No)</span>
            <span>Location</span>
          </div>
          <div class="retrieval-form">
            <div class="retrieval-form-row">
              <label>Patient ID:</label>
              <input type="text" id="search-patient-id">
            </div>
            <div class="retrieval-form-row">
              <label>Last Name:</label>
              <input type="text" id="search-last-name">
            </div>
            <div class="retrieval-form-row">
              <label>First Name:</label>
              <input type="text" id="search-first-name">
            </div>
            <div class="retrieval-form-row">
              <label></label>
              <input type="checkbox" id="search-phonetic">
              <span>Match Phonetically</span>
            </div>
            <div class="retrieval-form-row">
              <label>Test Date:</label>
              <input type="text" id="search-date" value="20-Dec-2025" style="width:90px;">
              <button class="win-btn" style="min-width:20px;padding:0 4px;">...</button>
            </div>
            <div class="retrieval-form-row">
              <label>Test Type:</label>
              <select id="search-test-type">
                <option>All</option>
                <option>ECG</option>
              </select>
            </div>
            <div class="retrieval-form-row">
              <label>Order Number:</label>
              <input type="text" id="search-order">
            </div>
            <div class="retrieval-form-buttons">
              <button class="win-btn" onclick="searchECGs()">Search</button>
              <button class="win-btn" onclick="clearSearch()">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== ECG VIEWER VIEW ========== -->
    <div class="view-container" id="view-ecg-viewer" style="display:none;">
    <!-- Tab Bar (MUSE-style) -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="current-ecg">
        <span class="tab-icon">üìà</span>
        Current ECG
      </button>
      <button class="tab-btn" data-tab="measurements">
        <span class="tab-icon">üìä</span>
        Measurements
      </button>
      <button class="tab-btn" data-tab="clerical">
        <span class="tab-icon">üìù</span>
        Clerical
      </button>
      <button class="tab-btn" data-tab="serial">
        <span class="tab-icon">üìë</span>
        Serial Presentation
      </button>
      <button class="tab-btn disabled" data-tab="no-previous">
        <span class="tab-icon"></span>
        (No Previous)
      </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel -->
      <div class="left-panel">
        <!-- Patient Information (MUSE-style compact layout) -->
        <div class="muse-patient-panel">
          <div class="muse-field-row">
            <label>Patient ID:</label>
            <input type="text" id="patient-id" value="12345678" readonly>
            <select class="muse-dropdown" disabled><option>‚ñº</option></select>
          </div>
          <div class="muse-field-row">
            <label>Last, First:</label>
            <input type="text" id="patient-name" value="DOE, JANE" readonly>
          </div>
          <div class="muse-field-row">
            <label>Test Date/Time:</label>
            <input type="text" id="patient-datetime" value="" readonly>
          </div>
          <div class="muse-field-row">
            <label>Sex:</label>
            <select id="patient-sex" disabled>
              <option value="M">M</option>
              <option value="F" selected>F</option>
            </select>
            <select class="muse-dropdown" disabled><option>‚ñº</option></select>
          </div>
          <div class="muse-field-row">
            <label>Ht, Wt (in, lb):</label>
            <input type="text" id="patient-height" value="36" readonly style="width:30px;">
            <span>,</span>
            <input type="text" id="patient-weight" value="28" readonly style="width:30px;">
            <span style="margin-left:8px;">BP:</span>
            <input type="text" id="patient-bp" value="" readonly style="width:50px;">
            <span>mm Hg</span>
          </div>
          <div class="muse-field-row">
            <label>Location:</label>
            <input type="text" id="patient-location" value="Peds Cardiology" readonly>
          </div>
          <div class="muse-mismatch-status" id="mismatch-status">No Mismatch Detected</div>
        </div>

        <!-- Measurements (MUSE-style with header) -->
        <div class="muse-measurements-panel">
          <div class="section-header">Measurements</div>
          <div class="muse-meas-body">
            <div class="muse-meas-row">
              <span class="meas-label">Vent rate:</span>
              <input type="text" id="meas-vent-rate" value="--" readonly style="width:40px;">
              <span class="meas-unit">bpm</span>
              <span class="meas-range" id="meas-vent-range"></span>
            </div>
            <div class="muse-meas-row">
              <span class="meas-label">PR int:</span>
              <input type="text" id="meas-pr" value="--" readonly style="width:40px;">
              <span class="meas-unit">ms</span>
              <span class="meas-range" id="meas-pr-range"></span>
            </div>
            <div class="muse-meas-row">
              <span class="meas-label">QRS dur:</span>
              <input type="text" id="meas-qrs" value="--" readonly style="width:40px;">
              <span class="meas-unit">ms</span>
              <span class="meas-range" id="meas-qrs-range"></span>
            </div>
            <div class="muse-meas-row">
              <span class="meas-label">QT/QTc:</span>
              <input type="text" id="meas-qt" value="--" readonly style="width:35px;">
              <span class="meas-unit">/</span>
              <input type="text" id="meas-qtc" value="--" readonly style="width:35px;">
              <span class="meas-unit">ms</span>
              <span class="meas-range" id="meas-qtc-range"></span>
            </div>
            <div class="muse-meas-row">
              <span class="meas-label">P-R-T axes:</span>
              <input type="text" id="meas-p-axis" value="--" readonly style="width:28px;">
              <input type="text" id="meas-qrs-axis" value="--" readonly style="width:28px;">
              <input type="text" id="meas-t-axis" value="--" readonly style="width:28px;">
              <span class="meas-unit">¬∞</span>
            </div>
            <div class="muse-meas-row">
              <span class="meas-label">RV5/SV1:</span>
              <input type="text" id="meas-rv5" value="--" readonly style="width:35px;">
              <span class="meas-unit">/</span>
              <input type="text" id="meas-sv1" value="--" readonly style="width:35px;">
              <span class="meas-unit">mV</span>
            </div>
          </div>
        </div>

        <!-- Confirmation Status -->
        <div class="muse-confirm-panel">
          <span class="badge badge-unconfirmed" id="confirm-status" onclick="toggleConfirmation()" style="cursor:pointer;" title="Click to confirm/unconfirm">UNCONFIRMED</span>
          <div id="confirm-details" style="display:none;margin-top:5px;font-size:10px;">
            <div><b>Confirmed by:</b> <span id="confirm-physician">--</span></div>
            <div><b>Date/Time:</b> <span id="confirm-datetime">--</span></div>
          </div>
          <div style="margin-top:8px;">
            <button class="win-btn" onclick="showConfirmDialog()" style="font-size:10px;padding:2px 8px;">Confirm ECG...</button>
          </div>
        </div>

        <!-- ML Screening Panel -->
        <div class="ml-screening-panel">
          <div class="section-header">ML Screening</div>
          <div class="ml-status" id="ml-status">
            <span class="ml-status-text">Not connected</span>
          </div>
          <div class="ml-predictions" id="ml-predictions">
            <div class="ml-pred-row">
              <span class="ml-pred-label">CHD:</span>
              <span class="ml-pred-value" id="ml-chd">--</span>
              <span class="ml-pred-bar"><span class="ml-pred-fill" id="ml-chd-bar"></span></span>
            </div>
            <div class="ml-pred-row">
              <span class="ml-pred-label">Kawasaki:</span>
              <span class="ml-pred-value" id="ml-kawasaki">--</span>
              <span class="ml-pred-bar"><span class="ml-pred-fill" id="ml-kawasaki-bar"></span></span>
            </div>
            <div class="ml-pred-row">
              <span class="ml-pred-label">Cardiomyopathy:</span>
              <span class="ml-pred-value" id="ml-cardiomyopathy">--</span>
              <span class="ml-pred-bar"><span class="ml-pred-fill" id="ml-cardiomyopathy-bar"></span></span>
            </div>
          </div>
          <div class="ml-warnings" id="ml-warnings" style="display:none;"></div>
          <div class="ml-disclaimer">
            <small>AI screening only. Not a diagnosis. Clinical correlation required.</small>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <!-- ECG Secondary Toolbar -->
        <div class="ecg-toolbar">
          <button class="ecg-tool-btn" id="btn-calipers" title="Calipers (Time/Rate)">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <line x1="6" y1="4" x2="6" y2="20"/>
              <line x1="18" y1="4" x2="18" y2="20"/>
              <line x1="6" y1="12" x2="18" y2="12"/>
              <line x1="4" y1="4" x2="8" y2="4"/>
              <line x1="4" y1="20" x2="8" y2="20"/>
              <line x1="16" y1="4" x2="20" y2="4"/>
              <line x1="16" y1="20" x2="20" y2="20"/>
            </svg>
          </button>
          <button class="ecg-tool-btn" id="btn-amplitude" title="Amplitude Calipers">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <line x1="4" y1="6" x2="20" y2="6"/>
              <line x1="4" y1="18" x2="20" y2="18"/>
              <line x1="12" y1="6" x2="12" y2="18"/>
              <line x1="4" y1="4" x2="4" y2="8"/>
              <line x1="20" y1="4" x2="20" y2="8"/>
              <line x1="4" y1="16" x2="4" y2="20"/>
              <line x1="20" y1="16" x2="20" y2="20"/>
            </svg>
          </button>
          <div class="ecg-tool-separator"></div>
          <button class="ecg-tool-btn" id="btn-clear-calipers" title="Clear Measurements">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <path d="M3 6h18M8 6V4h8v2M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6"/>
            </svg>
          </button>
          <button class="ecg-tool-btn" id="btn-annotations" title="Show Interval Annotations (PR, QRS, QT)">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <path d="M4 12h16"/>
              <path d="M4 8h2v8H4z" fill="currentColor"/>
              <path d="M18 8h2v8h-2z" fill="currentColor"/>
              <text x="12" y="15" text-anchor="middle" font-size="6" fill="currentColor" stroke="none">QT</text>
            </svg>
          </button>
          <div class="ecg-tool-separator"></div>
          <button class="ecg-tool-btn" id="btn-zoom-region" title="Zoom Region">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <circle cx="10" cy="10" r="7"/>
              <line x1="15" y1="15" x2="21" y2="21"/>
              <line x1="7" y1="10" x2="13" y2="10"/>
              <line x1="10" y1="7" x2="10" y2="13"/>
            </svg>
          </button>
          <button class="ecg-tool-btn" id="btn-pan" title="Pan">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <path d="M12 2v4M12 18v4M2 12h4M18 12h4M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M5.6 18.4l2.8-2.8M15.6 8.4l2.8-2.8"/>
            </svg>
          </button>
          <div class="ecg-tool-separator"></div>
          <button class="ecg-tool-btn active" id="btn-grid" title="Show Grid">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2">
              <rect x="3" y="3" width="18" height="18"/>
              <line x1="3" y1="9" x2="21" y2="9"/>
              <line x1="3" y1="15" x2="21" y2="15"/>
              <line x1="9" y1="3" x2="9" y2="21"/>
              <line x1="15" y1="3" x2="15" y2="21"/>
            </svg>
          </button>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content active" id="content-current-ecg">
          <!-- Interpretation Panel (above ECG) -->
          <div class="ecg-interpretation-panel">
            <div class="interp-header">** ** ** ** * Pediatric ECG Analysis * ** ** ** **</div>
            <div class="interp-body">
              <div id="ecg-interpretation-text">
                <div class="interp-line">Normal sinus rhythm</div>
                <div class="interp-line">Normal ECG for age</div>
              </div>
              <div class="interp-link">
                <a href="#" id="ecg-prev-link">No previous ECGs available.</a>
              </div>
            </div>
          </div>
          <!-- ECG Canvas -->
          <div class="ecg-canvas-container" id="ecg-canvas-container">
            <div class="ecg-canvas-wrapper">
              <canvas id="ecg-canvas"></canvas>
            </div>
          </div>
        </div>

        <div class="tab-content" id="content-rhythm">
          <div class="ecg-canvas-container">
            <div class="ecg-canvas-wrapper">
              <canvas id="rhythm-canvas"></canvas>
            </div>
          </div>
        </div>

        <div class="tab-content" id="content-measurements">
          <div class="measurements-table-container">
            <table class="measurements-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Value</th>
                  <th>Unit</th>
                  <th>Normal Range</th>
                </tr>
              </thead>
              <tbody id="measurements-table-body">
                <tr><td>Ventricular Rate</td><td>130</td><td>BPM</td><td>100-160</td></tr>
                <tr><td>Atrial Rate</td><td>130</td><td>BPM</td><td>100-160</td></tr>
                <tr><td>PR Interval</td><td>110</td><td>ms</td><td>80-150</td></tr>
                <tr><td>QRS Duration</td><td>72</td><td>ms</td><td>50-90</td></tr>
                <tr><td>QT Interval</td><td>320</td><td>ms</td><td>260-400</td></tr>
                <tr><td>QTc (Bazett)</td><td>410</td><td>ms</td><td>350-450</td></tr>
                <tr><td>P Axis</td><td>65</td><td>deg</td><td>0-90</td></tr>
                <tr><td>QRS Axis</td><td>80</td><td>deg</td><td>30-180</td></tr>
                <tr><td>T Axis</td><td>56</td><td>deg</td><td>-10-75</td></tr>
                <tr><td>RR Interval</td><td>462</td><td>ms</td><td>375-600</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Clerical Tab -->
        <div class="tab-content" id="content-clerical">
          <div class="clerical-container">
            <!-- Interpretation Section (top) -->
            <div class="clerical-interpretation">
              <div class="clerical-interp-text" id="clerical-interp">
                ** ** ** ** * Pediatric ECG Analysis * ** ** ** **<br>
                Normal sinus rhythm<br>
                Normal ECG for age
              </div>
              <a href="#" class="clerical-prev-link">No previous ECGs available.</a>
            </div>

            <!-- Form Section -->
            <div class="clerical-form">
              <!-- Left Column - Patient Demographics -->
              <div class="clerical-col clerical-col-left">
                <div class="clerical-row">
                  <label>Patient ID:</label>
                  <input type="text" id="cler-patient-id" value="12345678">
                </div>
                <div class="clerical-row">
                  <label>Last, First Name:</label>
                  <input type="text" id="cler-last-name" value="DOE" style="width:100px;">
                  <input type="text" id="cler-first-name" value="JANE" style="width:80px;">
                  <select style="width:20px;"><option>‚ñº</option></select>
                </div>
                <div class="clerical-row">
                  <label>Test Date/Time:</label>
                  <input type="text" id="cler-test-datetime" value="18-Dec-2025 08:47:08">
                </div>
                <div class="clerical-row">
                  <label>Age/DOB:</label>
                  <input type="text" id="cler-age" value="3" style="width:30px;">
                  <input type="text" id="cler-dob" value="03/15/2021" style="width:80px;">
                </div>
                <div class="clerical-row">
                  <label>Sex, Race:</label>
                  <select id="cler-sex" style="width:60px;">
                    <option value="Male">Male</option>
                    <option value="Female" selected>Female</option>
                  </select>
                  <select id="cler-race" style="width:100px;">
                    <option value="">---</option>
                    <option value="White">White</option>
                    <option value="Black">Black</option>
                    <option value="Asian">Asian</option>
                    <option value="Hispanic">Hispanic</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="clerical-row">
                  <label>Ht, Wt (in, lb):</label>
                  <input type="text" id="cler-height" value="36" style="width:35px;">
                  <input type="text" id="cler-weight" value="28" style="width:35px;">
                  <span style="margin-left:10px;">Option Number:</span>
                  <input type="text" id="cler-option" value="" style="width:40px;">
                </div>
                <div class="clerical-row">
                  <label>Location:</label>
                  <input type="text" id="cler-location" value="Peds Cardiology" style="width:150px;">
                  <select style="width:20px;"><option>‚ñº</option></select>
                </div>
                <div class="clerical-row">
                  <label>Cart Number:</label>
                  <input type="text" id="cler-cart-num" value="0" style="width:40px;">
                  <span style="margin-left:10px;">Room Number:</span>
                  <input type="text" id="cler-room" value="" style="width:60px;">
                </div>
                <div class="clerical-row">
                  <label>Cart SN:</label>
                  <input type="text" id="cler-cart-sn" value="">
                </div>
                <div class="clerical-row">
                  <label>Test Reason:</label>
                  <input type="text" id="cler-test-reason" value="R01.1">
                </div>
                <div class="clerical-row">
                  <label>Notified:</label>
                  <input type="text" id="cler-notified" value="">
                </div>
              </div>

              <!-- Center Column - Status Banner -->
              <div class="clerical-col clerical-col-center">
                <div class="clerical-mismatch-banner">No Mismatch Detected</div>
              </div>

              <!-- Right Column - Clinical Info -->
              <div class="clerical-col clerical-col-right">
                <div class="clerical-row">
                  <label>Referring Phys:</label>
                  <input type="text" id="cler-referring" value="">
                </div>
                <div class="clerical-row">
                  <label>Ordering Phys:</label>
                  <input type="text" id="cler-ordering" value="">
                </div>
                <div class="clerical-row">
                  <label>Acquiring Tech:</label>
                  <input type="text" id="cler-acquiring" value="">
                </div>
                <div class="clerical-row">
                  <label>Admitting Phys:</label>
                  <input type="text" id="cler-admitting" value="">
                </div>
                <div class="clerical-row">
                  <label>Attending Phys:</label>
                  <input type="text" id="cler-attending" value="">
                </div>
                <div class="clerical-row">
                  <label>Primary Care Phys:</label>
                  <input type="text" id="cler-primary-care" value="">
                </div>
                <div class="clerical-row">
                  <label>Editor:</label>
                  <input type="text" id="cler-editor" value="">
                </div>
                <div class="clerical-row">
                  <label>Fellow:</label>
                  <input type="text" id="cler-fellow" value="">
                </div>
                <div class="clerical-row">
                  <label>Confirmed by:</label>
                  <input type="text" id="cler-confirmed-by" value="">
                </div>
                <div class="clerical-row">
                  <label>Edit Date/Time:</label>
                  <input type="text" id="cler-edit-datetime" value="">
                </div>
                <div class="clerical-row">
                  <label>Order Number:</label>
                  <input type="text" id="cler-order-num" value="">
                </div>
                <div class="clerical-row">
                  <label>Visit Number:</label>
                  <input type="text" id="cler-visit-num" value="">
                </div>
                <div class="clerical-row">
                  <label>Account Number:</label>
                  <input type="text" id="cler-account-num" value="">
                </div>
                <div class="clerical-row">
                  <label>User Defined:</label>
                  <input type="text" id="cler-user-defined" value="" style="width:80px;">
                  <input type="checkbox" id="cler-do-not-bill">
                  <span>Do not bill</span>
                </div>
                <div class="clerical-row">
                  <label>Secondary ID:</label>
                  <input type="text" id="cler-secondary-id" value="">
                </div>
              </div>
            </div>

            <!-- Bottom Section - Measurements -->
            <div class="clerical-measurements">
              <div class="clerical-meas-row">
                <label>Ventricular, atrial rate:</label>
                <input type="text" id="cler-vent-rate" value="130" style="width:35px;">
                <input type="text" id="cler-atrial-rate" value="130" style="width:35px;">
                <span>bpm</span>
              </div>
              <div class="clerical-meas-row">
                <label>PR, QRS:</label>
                <input type="text" id="cler-pr" value="110" style="width:35px;">
                <input type="text" id="cler-qrs" value="72" style="width:35px;">
                <span>ms</span>
              </div>
              <div class="clerical-meas-row">
                <label>QT, QTcB:</label>
                <input type="text" id="cler-qt" value="320" style="width:35px;">
                <input type="text" id="cler-qtc" value="410" style="width:35px;">
                <span>ms</span>
              </div>
              <div class="clerical-meas-row">
                <label>PRT Axis:</label>
                <input type="text" id="cler-p-axis" value="65" style="width:30px;">
                <input type="text" id="cler-qrs-axis" value="80" style="width:30px;">
                <input type="text" id="cler-t-axis" value="56" style="width:30px;">
                <span>¬∞</span>
              </div>
              <div class="clerical-meas-row">
                <label>BP:</label>
                <input type="text" id="cler-bp-sys" value="" style="width:35px;">
                <span>/</span>
                <input type="text" id="cler-bp-dia" value="" style="width:35px;">
                <span>mm Hg</span>
              </div>
              <button class="win-btn" onclick="showChangeLog()">Change Log</button>
            </div>
          </div>
        </div>

        <!-- Serial Presentation Tab -->
        <div class="tab-content" id="content-serial">
          <div class="serial-content" style="display:flex;flex-direction:column;height:100%;padding:10px;">
            <!-- Timeline Header -->
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:5px;background:#f0f0f0;border:1px solid #ccc;">
              <span style="font-weight:bold;font-size:12px;">Patient ECG History</span>
              <span style="font-size:11px;color:#666;" id="serial-patient-name">DOE, JANE</span>
              <span style="margin-left:auto;font-size:10px;">
                <button class="win-btn" style="font-size:10px;" onclick="addDemoSerialECGs()">Load Demo ECGs</button>
              </span>
            </div>

            <!-- Timeline View -->
            <div style="display:flex;gap:5px;margin-bottom:15px;padding:10px;background:#fff;border:1px solid #ccc;overflow-x:auto;">
              <div id="serial-timeline" style="display:flex;gap:15px;min-height:40px;align-items:center;">
                <span style="color:#999;font-size:11px;">No previous ECGs in history</span>
              </div>
            </div>

            <!-- ECG Thumbnails Gallery -->
            <div style="flex:1;overflow-y:auto;padding:10px;background:#e8e8e8;border:1px solid #ccc;">
              <div id="serial-thumbnails" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:15px;">
                <!-- Thumbnails will be added dynamically -->
                <div style="text-align:center;padding:40px;color:#666;font-size:12px;">
                  Click "Load Demo ECGs" to see example serial ECGs,<br>
                  or load MUSE XML files using File > Open.
                </div>
              </div>
            </div>

            <!-- Selected ECG Preview -->
            <div style="margin-top:10px;padding:10px;background:#fff;border:1px solid #ccc;display:none;" id="serial-preview-panel">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <span style="font-weight:bold;font-size:12px;">Selected ECG Preview</span>
                <span id="serial-preview-date" style="font-size:11px;color:#666;"></span>
              </div>
              <canvas id="serial-preview-canvas" style="width:100%;height:150px;background:#FFF4F4;border:1px solid #ddd;"></canvas>
            </div>
          </div>
        </div>

        <!-- No Previous Tab (placeholder) -->
        <div class="tab-content" id="content-no-previous">
          <div class="no-previous-content">
            No previous ECGs available for this patient.
          </div>
        </div>
      </div>
    </div>
    </div> <!-- End ECG Viewer View -->

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <span class="status-label">User:</span>
        <span class="status-value">SYSTEM</span>
      </div>
      <div class="status-separator"></div>
      <div class="status-item">
        <span class="status-label">Site:</span>
        <span class="status-value">Peds Cardiology</span>
      </div>
      <div class="status-separator"></div>
      <div class="status-item">
        <span class="status-label">ID:</span>
        <span class="status-value" id="status-id">12345678</span>
      </div>
      <div class="status-separator"></div>
      <div class="status-item">
        <span class="status-label">Acquired:</span>
        <span class="status-value" id="status-acquired">12/20/2025, 4:04:01 PM</span>
      </div>
      <div class="status-bar-right">GEMUSE v1.0 - Pediatric ECG System</div>
    </div>

    <input type="file" id="file-input" accept=".xml,.ecg,.dat,.dcm,.scp,.png,.jpg,.jpeg,.gif,.bmp,.webp">

    <!-- ========== MODAL DIALOGS ========== -->

    <!-- Settings Dialog -->
    <div class="modal-overlay" id="settings-modal">
      <div class="modal-dialog settings-dialog">
        <div class="modal-title-bar">
          <span>Settings</span>
          <button class="modal-close-btn" onclick="closeModal('settings-modal')">X</button>
        </div>
        <div class="modal-body">
          <div class="dialog-tabs">
            <div class="dialog-tab active" data-settings-tab="display">Display</div>
            <div class="dialog-tab" data-settings-tab="print">Print</div>
            <div class="dialog-tab" data-settings-tab="preferences">Preferences</div>
          </div>

          <!-- Display Tab -->
          <div class="dialog-tab-content active" id="settings-display">
            <fieldset class="dialog-group">
              <legend>Default Display Settings</legend>
              <div class="dialog-form-row">
                <label>Lead Format:</label>
                <select id="settings-format">
                  <option value="12">12-Lead Standard</option>
                  <option value="15" selected>15-Lead Pediatric</option>
                </select>
              </div>
              <div class="dialog-form-row">
                <label>Paper Speed:</label>
                <select id="settings-speed">
                  <option value="25" selected>25 mm/s</option>
                  <option value="50">50 mm/s</option>
                </select>
              </div>
              <div class="dialog-form-row">
                <label>Gain:</label>
                <select id="settings-gain">
                  <option value="5">5 mm/mV</option>
                  <option value="10" selected>10 mm/mV</option>
                  <option value="20">20 mm/mV</option>
                </select>
              </div>
            </fieldset>
            <fieldset class="dialog-group">
              <legend>Grid Display</legend>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-show-grid" checked>
                <span style="font-size:11px;">Show ECG grid lines</span>
              </div>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-show-overlays" checked>
                <span style="font-size:11px;">Show interpretation overlay</span>
              </div>
            </fieldset>
          </div>

          <!-- Print Tab -->
          <div class="dialog-tab-content" id="settings-print">
            <fieldset class="dialog-group">
              <legend>Page Setup</legend>
              <div class="dialog-form-row">
                <label>Paper Size:</label>
                <select id="settings-paper-size">
                  <option value="letter" selected>Letter (8.5" x 11")</option>
                  <option value="legal">Legal (8.5" x 14")</option>
                  <option value="a4">A4 (210mm x 297mm)</option>
                </select>
              </div>
              <div class="dialog-form-row">
                <label>Orientation:</label>
                <select id="settings-orientation">
                  <option value="landscape" selected>Landscape</option>
                  <option value="portrait">Portrait</option>
                </select>
              </div>
              <div class="dialog-form-row">
                <label>Margins:</label>
                <select id="settings-margins">
                  <option value="normal" selected>Normal</option>
                  <option value="narrow">Narrow</option>
                  <option value="wide">Wide</option>
                </select>
              </div>
            </fieldset>
            <fieldset class="dialog-group">
              <legend>Print Options</legend>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-print-header" checked>
                <span style="font-size:11px;">Include patient header</span>
              </div>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-print-interp" checked>
                <span style="font-size:11px;">Include interpretation</span>
              </div>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-print-color">
                <span style="font-size:11px;">Print in color</span>
              </div>
            </fieldset>
          </div>

          <!-- Preferences Tab -->
          <div class="dialog-tab-content" id="settings-preferences">
            <fieldset class="dialog-group">
              <legend>User Preferences</legend>
              <div class="dialog-form-row">
                <label>Username:</label>
                <input type="text" id="settings-username" value="SYSTEM">
              </div>
              <div class="dialog-form-row">
                <label>Site:</label>
                <input type="text" id="settings-site" value="Peds Cardiology">
              </div>
            </fieldset>
            <fieldset class="dialog-group">
              <legend>Startup Options</legend>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-auto-load">
                <span style="font-size:11px;">Automatically load last ECG</span>
              </div>
              <div class="dialog-form-row">
                <label></label>
                <input type="checkbox" id="settings-confirm-exit" checked>
                <span style="font-size:11px;">Confirm before exit</span>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="modal-footer">
          <button class="win-btn primary" onclick="applySettings()">OK</button>
          <button class="win-btn" onclick="closeModal('settings-modal')">Cancel</button>
          <button class="win-btn" onclick="applySettings(); closeModal('settings-modal');">Apply</button>
        </div>
      </div>
    </div>

    <!-- Patient Information Dialog -->
    <div class="modal-overlay" id="patient-modal">
      <div class="modal-dialog patient-dialog">
        <div class="modal-title-bar">
          <span>Patient Information</span>
          <button class="modal-close-btn" onclick="closeModal('patient-modal')">X</button>
        </div>
        <div class="modal-body">
          <fieldset class="dialog-group">
            <legend>Demographics</legend>
            <div class="dialog-form-row">
              <label>Patient ID:</label>
              <input type="text" id="edit-patient-id">
            </div>
            <div class="dialog-form-row">
              <label>Last Name:</label>
              <input type="text" id="edit-patient-last">
            </div>
            <div class="dialog-form-row">
              <label>First Name:</label>
              <input type="text" id="edit-patient-first">
            </div>
            <div class="dialog-form-row">
              <label>Date of Birth:</label>
              <input type="text" id="edit-patient-dob" placeholder="MM/DD/YYYY">
            </div>
            <div class="dialog-form-row">
              <label>Age:</label>
              <input type="text" id="edit-patient-age">
            </div>
            <div class="dialog-form-row">
              <label>Sex:</label>
              <select id="edit-patient-sex">
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="U">Unknown</option>
              </select>
            </div>
            <div class="dialog-form-row">
              <label>Race:</label>
              <input type="text" id="edit-patient-race">
            </div>
          </fieldset>
          <fieldset class="dialog-group">
            <legend>Clinical Information</legend>
            <div class="dialog-form-row">
              <label>Location:</label>
              <input type="text" id="edit-patient-location">
            </div>
            <div class="dialog-form-row">
              <label>Room:</label>
              <input type="text" id="edit-patient-room">
            </div>
            <div class="dialog-form-row">
              <label>Referred by:</label>
              <input type="text" id="edit-patient-referred">
            </div>
            <div class="dialog-form-row">
              <label>Technician:</label>
              <input type="text" id="edit-patient-tech">
            </div>
          </fieldset>
          <fieldset class="dialog-group">
            <legend>Clinical Notes</legend>
            <div class="dialog-form-row">
              <label>Notes:</label>
              <textarea id="edit-patient-notes" rows="3"></textarea>
            </div>
          </fieldset>
        </div>
        <div class="modal-footer">
          <button class="win-btn primary" onclick="savePatientInfo()">OK</button>
          <button class="win-btn" onclick="closeModal('patient-modal')">Cancel</button>
        </div>
      </div>
    </div>

    <!-- About Dialog -->
    <div class="modal-overlay" id="about-modal">
      <div class="modal-dialog about-dialog">
        <div class="modal-title-bar">
          <span>About GEMUSE</span>
          <button class="modal-close-btn" onclick="closeModal('about-modal')">X</button>
        </div>
        <div class="modal-body">
          <div class="about-content">
            <div class="about-icon">‚ù§Ô∏è</div>
            <div class="about-info">
              <h2>GEMUSE</h2>
              <div>ECG Management System</div>
              <div>Version 1.0.0 (Build 2025.12.20)</div>
              <div class="about-separator"></div>
              <div>A pixel-perfect replica of the GE MUSE v9.0 interface</div>
              <div>Designed for pediatric cardiology ECG viewing and analysis</div>
              <div class="about-copyright">
                Copyright &copy; 2025 Demo Application<br>
                For educational and demonstration purposes only.
              </div>
            </div>
          </div>
          <div class="about-system-info" id="about-system-info">
            Loading system information...
          </div>
        </div>
        <div class="modal-footer">
          <button class="win-btn" onclick="showSystemInfo()">System Info...</button>
          <button class="win-btn primary" onclick="closeModal('about-modal')">OK</button>
        </div>
      </div>
    </div>

    <!-- Print Preview Dialog -->
    <div class="modal-overlay" id="print-preview-modal">
      <div class="modal-dialog print-preview-dialog">
        <div class="modal-title-bar">
          <span>Print Preview</span>
          <button class="modal-close-btn" onclick="closeModal('print-preview-modal')">X</button>
        </div>
        <div class="print-preview-toolbar">
          <button class="win-btn" onclick="doPrint()">Print...</button>
          <div style="width:20px;"></div>
          <label>Zoom:</label>
          <select id="preview-zoom" onchange="updatePreviewZoom()">
            <option value="0.5">50%</option>
            <option value="0.7" selected>70%</option>
            <option value="1.0">100%</option>
            <option value="1.5">150%</option>
          </select>
          <div style="width:20px;"></div>
          <label>Page:</label>
          <span id="preview-page-info">1 of 1</span>
        </div>
        <div class="print-preview-container">
          <div class="print-preview-page" id="print-preview-page">
            <canvas id="preview-canvas"></canvas>
          </div>
        </div>
        <div class="modal-footer">
          <button class="win-btn" onclick="exportPDF()">Export PDF</button>
          <button class="win-btn primary" onclick="doPrint()">Print</button>
          <button class="win-btn" onclick="closeModal('print-preview-modal')">Close</button>
        </div>
      </div>
    </div>

    <!-- ECG Compare Dialog -->
    <div class="modal-overlay" id="compare-modal">
      <div class="modal-dialog compare-dialog" style="width:800px;height:600px;">
        <div class="modal-title-bar">
          <span>Compare ECGs</span>
          <button class="modal-close-btn" onclick="closeModal('compare-modal')">X</button>
        </div>
        <div class="modal-body" style="padding:10px;">
          <div style="display:flex;gap:10px;margin-bottom:10px;">
            <fieldset class="dialog-group" style="flex:1;">
              <legend>Current ECG</legend>
              <div style="font-size:11px;">
                <div id="compare-current-name">DOE, JANE</div>
                <div id="compare-current-date">12/20/2025</div>
              </div>
            </fieldset>
            <fieldset class="dialog-group" style="flex:1;">
              <legend>Comparison ECG</legend>
              <div style="display:flex;gap:5px;align-items:center;">
                <button class="win-btn" id="btn-load-compare" style="font-size:10px;">Load ECG...</button>
                <span id="compare-loaded-name" style="font-size:11px;">No ECG loaded</span>
              </div>
            </fieldset>
          </div>
          <div style="display:flex;gap:10px;margin-bottom:10px;">
            <label style="font-size:11px;display:flex;align-items:center;gap:5px;">
              <input type="radio" name="compare-mode" value="side-by-side" checked> Side by Side
            </label>
            <label style="font-size:11px;display:flex;align-items:center;gap:5px;">
              <input type="radio" name="compare-mode" value="overlay"> Overlay
            </label>
            <label style="font-size:11px;display:flex;align-items:center;gap:5px;margin-left:20px;">
              Lead:
              <select id="compare-lead" style="font-size:10px;">
                <option value="II">II</option>
                <option value="I">I</option>
                <option value="III">III</option>
                <option value="aVR">aVR</option>
                <option value="aVL">aVL</option>
                <option value="aVF">aVF</option>
                <option value="V1">V1</option>
                <option value="V2">V2</option>
                <option value="V3">V3</option>
                <option value="V4">V4</option>
                <option value="V5">V5</option>
                <option value="V6">V6</option>
              </select>
            </label>
          </div>
          <div id="compare-canvas-container" style="flex:1;background:#FFF4F4;border:1px solid #ccc;overflow:auto;">
            <canvas id="compare-canvas" style="display:block;"></canvas>
          </div>
          <div id="compare-measurements" style="margin-top:10px;font-size:10px;display:flex;gap:20px;">
            <div><b>Current:</b> <span id="compare-meas-current">--</span></div>
            <div><b>Comparison:</b> <span id="compare-meas-compare">--</span></div>
            <div><b>Difference:</b> <span id="compare-meas-diff">--</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="win-btn primary" onclick="closeModal('compare-modal')">Close</button>
        </div>
      </div>
    </div>

    <input type="file" id="compare-file-input" accept=".xml,.ecg,.dat,.dcm,.scp" style="display:none;">

    <!-- ECG Confirmation Dialog -->
    <div class="modal-overlay" id="confirm-dialog">
      <div class="modal-dialog" style="width:400px;">
        <div class="modal-title-bar">
          <span>Confirm ECG Interpretation</span>
          <button class="modal-close-btn" onclick="closeModal('confirm-dialog')">X</button>
        </div>
        <div class="modal-body" style="padding:15px;">
          <fieldset class="dialog-group">
            <legend>Physician Signature</legend>
            <div class="dialog-form-row">
              <label>Physician Name:</label>
              <input type="text" id="confirm-physician-name" placeholder="Enter your name" style="width:180px;">
            </div>
            <div class="dialog-form-row">
              <label>Physician ID:</label>
              <input type="text" id="confirm-physician-id" placeholder="Badge/ID number" style="width:180px;">
            </div>
            <div class="dialog-form-row">
              <label>Password:</label>
              <input type="password" id="confirm-password" placeholder="Enter password" style="width:180px;">
            </div>
          </fieldset>
          <fieldset class="dialog-group" style="margin-top:10px;">
            <legend>Confirmation</legend>
            <div style="font-size:11px;margin-bottom:10px;">
              By clicking "Confirm", I attest that I have reviewed this ECG and agree with the interpretation.
            </div>
            <div class="dialog-form-row">
              <label></label>
              <input type="checkbox" id="confirm-agree">
              <span style="font-size:11px;">I confirm this interpretation is accurate</span>
            </div>
          </fieldset>
        </div>
        <div class="modal-footer">
          <button class="win-btn primary" onclick="confirmECG()">Confirm</button>
          <button class="win-btn" onclick="rejectECGDialog()">Reject</button>
          <button class="win-btn" onclick="closeModal('confirm-dialog')">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import sample ECG data
    import { sampleECG } from './src/data/sample-ecg.ts';
    import { parseMuseXML } from './src/signal/loader/muse-xml.ts';
    import { parseHL7aECG } from './src/signal/loader/hl7-aecg.ts';
    import { parseDICOMECG } from './src/signal/loader/dicom-ecg.ts';
    import { parsePhilipsXML } from './src/signal/loader/philips-xml.ts';
    import { parseSCPECG } from './src/signal/loader/scp-ecg.ts';
    import { detectXMLFormat, detectBinaryFormat } from './src/signal/loader/index.ts';
    import { GuaranteedDigitizer } from './src/signal/loader/png-digitizer/guaranteed-digitizer.ts';
    import { CalipersManager } from './src/calipers.ts';
    const jsPDF = window.jspdf.jsPDF;
    import { calculateECGMeasurements } from './src/signal/analysis/ecg-measurements.ts';
    import { AGE_GROUPS, getAgeGroup, ageToDays } from './src/data/ageGroups.ts';
    import { getNormalsForAge, getClinicalNotes, classifyValue } from './src/data/pediatricNormals.ts';

    // ECG paper colors - Classic pink ECG paper
    const ECG_COLORS = {
      background: '#FFE4E4',    // Light pink ECG paper background
      thinLine: '#FFCCCC',      // Pink thin gridlines (1mm squares)
      thickLine: '#FF9999',     // Darker pink thick gridlines (5mm squares)
      waveform: '#000000',      // Black waveform traces
      separator: '#666666',     // Gray separators between lead cells
      text: '#000000',
      leadLabel: '#000000',     // Black lead labels
    };

    // Lead layouts
    const LEAD_LAYOUT_12 = [
      ['I', 'aVR', 'V1', 'V4'],
      ['II', 'aVL', 'V2', 'V5'],
      ['III', 'aVF', 'V3', 'V6'],
    ];

    const LEAD_LAYOUT_15 = [
      ['I', 'aVR', 'V1', 'V4', 'V3R'],
      ['II', 'aVL', 'V2', 'V5', 'V4R'],
      ['III', 'aVF', 'V3', 'V6', 'V7'],
    ];

    const RHYTHM_LEADS_15 = ['II'];  // Single rhythm strip - lead II
    const RHYTHM_LEADS_12 = ['II'];  // Single rhythm strip - lead II

    function pixelsPerMm(dpi) {
      return dpi / 25.4;
    }

    class GridRenderer {
      constructor(ctx, config) {
        this.ctx = ctx;
        this.config = config;
        this.pxPerMm = pixelsPerMm(config.dpi);
        this.smallBoxPx = this.pxPerMm * 1;
        this.largeBoxPx = this.pxPerMm * 5;
      }

      render(x, y, width, height, renderGridLines = true) {
        this.renderBackground(x, y, width, height);
        if (renderGridLines) {
          this.renderThinLines(x, y, width, height);
          this.renderThickLines(x, y, width, height);
        }
      }

      renderBackground(x, y, width, height) {
        this.ctx.fillStyle = ECG_COLORS.background;
        this.ctx.fillRect(x, y, width, height);
      }

      renderThinLines(startX, startY, width, height) {
        this.ctx.strokeStyle = ECG_COLORS.thinLine;
        this.ctx.lineWidth = 0.5;
        this.ctx.beginPath();

        // Draw vertical thin lines (skip every 5th - those are thick lines)
        for (let x = 0; x <= width; x += this.smallBoxPx) {
          const lineIndex = Math.round(x / this.smallBoxPx);
          if (lineIndex % 5 === 0) continue;
          const xPos = startX + x;
          this.ctx.moveTo(xPos, startY);
          this.ctx.lineTo(xPos, startY + height);
        }

        // Draw horizontal thin lines (skip every 5th)
        for (let y = 0; y <= height; y += this.smallBoxPx) {
          const lineIndex = Math.round(y / this.smallBoxPx);
          if (lineIndex % 5 === 0) continue;
          const yPos = startY + y;
          this.ctx.moveTo(startX, yPos);
          this.ctx.lineTo(startX + width, yPos);
        }

        this.ctx.stroke();
      }

      renderThickLines(startX, startY, width, height) {
        this.ctx.strokeStyle = ECG_COLORS.thickLine;
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();

        for (let x = 0; x <= width; x += this.largeBoxPx) {
          const xPos = Math.round(startX + x) + 0.5;
          this.ctx.moveTo(xPos, startY);
          this.ctx.lineTo(xPos, startY + height);
        }

        for (let y = 0; y <= height; y += this.largeBoxPx) {
          const yPos = Math.round(startY + y) + 0.5;
          this.ctx.moveTo(startX, yPos);
          this.ctx.lineTo(startX + width, yPos);
        }

        this.ctx.stroke();
      }

      getMetrics() {
        return {
          pxPerMm: this.pxPerMm,
          smallBoxPx: this.smallBoxPx,
          largeBoxPx: this.largeBoxPx,
        };
      }
    }

    function renderWaveform(ctx, samples, startX, baselineY, pxPerSample, pxPerUv, maxWidth) {
      if (!samples || samples.length === 0) return;

      const mean = samples.reduce((sum, v) => sum + v, 0) / samples.length;

      ctx.strokeStyle = ECG_COLORS.waveform;
      ctx.lineWidth = 1.25;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();

      let first = true;
      for (let i = 0; i < samples.length; i++) {
        const x = startX + i * pxPerSample;
        if (maxWidth && x > startX + maxWidth) break;
        const y = baselineY - (samples[i] - mean) * pxPerUv;

        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();
    }

    function drawCalibrationPulse(ctx, x, baselineY, pxPerMm, gain) {
      const pulseHeight = pxPerMm * gain;
      const pulseWidth = pxPerMm * 5;

      ctx.save();
      ctx.strokeStyle = ECG_COLORS.waveform;
      ctx.lineWidth = 2;
      ctx.lineCap = 'square';
      ctx.lineJoin = 'miter';

      ctx.beginPath();
      ctx.moveTo(x - 3, baselineY);
      ctx.lineTo(x, baselineY);
      ctx.lineTo(x, baselineY - pulseHeight);
      ctx.lineTo(x + pulseWidth, baselineY - pulseHeight);
      ctx.lineTo(x + pulseWidth, baselineY);
      ctx.lineTo(x + pulseWidth + 3, baselineY);
      ctx.stroke();
      ctx.restore();
    }

    function drawSeparators(ctx, gridArea, numCols, numRows, rowSpacing, colWidth, rhythmStartY) {
      ctx.strokeStyle = ECG_COLORS.separator;
      ctx.lineWidth = 1.5;
      ctx.lineCap = 'butt';
      ctx.beginPath();

      // Vertical separators between lead columns
      for (let col = 1; col < numCols; col++) {
        const x = Math.round(gridArea.x + col * colWidth);
        ctx.moveTo(x, gridArea.y);
        ctx.lineTo(x, gridArea.y + numRows * rowSpacing);
      }

      // Horizontal separators between lead rows
      for (let row = 1; row < numRows; row++) {
        const y = Math.round(gridArea.y + row * rowSpacing);
        ctx.moveTo(gridArea.x, y);
        ctx.lineTo(gridArea.x + numCols * colWidth, y);
      }

      // Separator before rhythm strips
      ctx.lineWidth = 2;
      ctx.moveTo(gridArea.x, rhythmStartY - 2);
      ctx.lineTo(gridArea.x + gridArea.width, rhythmStartY - 2);

      ctx.stroke();
    }

    // State
    let currentSignal = null;
    let currentPatient = null;
    let currentMeasurements = null;
    let currentZoom = 1;
    let ecgId = 'ECG-2025-001234';
    let calipers = null;
    let showGrid = true;
    let showAnnotations = false; // Show PR, QRS, QT measurement markers
    let currentTool = null; // 'calipers', 'amplitude', 'zoom-region', 'pan'
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let scrollStart = { x: 0, y: 0 };

    // ML Service Configuration
    const ML_API_URL = 'http://localhost:5050';
    let mlServiceConnected = false;

    /**
     * Check ML service health and update status
     */
    async function checkMLService() {
      const statusEl = document.getElementById('ml-status');
      try {
        const response = await fetch(`${ML_API_URL}/health`, {
          method: 'GET',
          signal: AbortSignal.timeout(3000)
        });
        if (response.ok) {
          const data = await response.json();
          mlServiceConnected = data.model_loaded;
          statusEl.className = 'ml-status connected';
          statusEl.innerHTML = '<span class="ml-status-text">‚úì ML model ready</span>';
        } else {
          throw new Error('Service not healthy');
        }
      } catch (e) {
        mlServiceConnected = false;
        statusEl.className = 'ml-status disconnected';
        statusEl.innerHTML = '<span class="ml-status-text">‚úó ML service offline</span>';
      }
    }

    /**
     * Get ML predictions for current ECG
     */
    async function getMLPredictions(signal, patientAge) {
      if (!mlServiceConnected) {
        await checkMLService();
        if (!mlServiceConnected) return null;
      }

      const statusEl = document.getElementById('ml-status');
      statusEl.className = 'ml-status loading';
      statusEl.innerHTML = '<span class="ml-status-text">‚ü≥ Analyzing...</span>';

      try {
        // Prepare signal data (12 leads x N samples)
        const leadOrder = ['I', 'II', 'III', 'aVR', 'aVL', 'aVF', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6'];
        const signalData = leadOrder.map(lead => {
          const samples = signal.leads[lead] || signal.leads[lead.toLowerCase()];
          return samples ? Array.from(samples) : new Array(signal.leads.II?.length || 5000).fill(0);
        });

        // Determine lead mask (which leads are present)
        const leadMask = leadOrder.map(lead => {
          const samples = signal.leads[lead] || signal.leads[lead.toLowerCase()];
          return samples ? 1 : 0;
        });

        const response = await fetch(`${ML_API_URL}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            signal: signalData,
            sample_rate: signal.sampleRate || 500,
            age_days: patientAge || 365 * 5,
            lead_mask: leadMask
          }),
          signal: AbortSignal.timeout(30000)
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const result = await response.json();
        statusEl.className = 'ml-status connected';
        statusEl.innerHTML = '<span class="ml-status-text">‚úì Analysis complete</span>';
        return result;
      } catch (e) {
        console.error('ML prediction error:', e);
        statusEl.className = 'ml-status disconnected';
        statusEl.innerHTML = `<span class="ml-status-text">‚úó ${e.message}</span>`;
        return null;
      }
    }

    /**
     * Update ML predictions UI panel
     */
    function updateMLPanel(predictions) {
      const conditions = ['CHD', 'Kawasaki', 'Cardiomyopathy'];

      if (!predictions || !predictions.predictions) {
        // Reset to default state
        conditions.forEach(cond => {
          const valueEl = document.getElementById(`ml-${cond.toLowerCase()}`);
          const barEl = document.getElementById(`ml-${cond.toLowerCase()}-bar`);
          if (valueEl) {
            valueEl.textContent = '--';
            valueEl.className = 'ml-pred-value';
          }
          if (barEl) {
            barEl.style.width = '0%';
            barEl.className = 'ml-pred-fill';
          }
        });
        document.getElementById('ml-warnings').style.display = 'none';
        return;
      }

      // Update predictions
      predictions.predictions.forEach(pred => {
        const condLower = pred.condition.toLowerCase();
        const valueEl = document.getElementById(`ml-${condLower}`);
        const barEl = document.getElementById(`ml-${condLower}-bar`);

        if (valueEl && barEl) {
          const pct = Math.round(pred.probability * 100);
          valueEl.textContent = `${pct}%`;
          valueEl.className = pred.positive ? 'ml-pred-value positive' : 'ml-pred-value negative';

          barEl.style.width = `${pct}%`;
          if (pct >= 50) {
            barEl.className = 'ml-pred-fill high';
          } else if (pct >= 20) {
            barEl.className = 'ml-pred-fill medium';
          } else {
            barEl.className = 'ml-pred-fill low';
          }
        }
      });

      // Update warnings
      const warningsEl = document.getElementById('ml-warnings');
      if (predictions.warnings && predictions.warnings.length > 0) {
        warningsEl.innerHTML = predictions.warnings.map(w =>
          `<div class="warning-item">‚ö† ${w.message}</div>`
        ).join('');
        warningsEl.style.display = 'block';
      } else {
        warningsEl.style.display = 'none';
      }
    }

    /**
     * Trigger ML analysis for current ECG
     */
    async function analyzeWithML() {
      if (!currentSignal) {
        updateMLPanel(null);
        return;
      }

      // Get patient age in days (from ageDays, or parse from age string, or default to 5 years)
      let patientAge = currentPatient?.ageDays;
      if (!patientAge && currentPatient?.age) {
        // Try to parse age string like "5 yr" or "3 mo"
        const match = currentPatient.age.match(/([\d.]+)\s*(yr|year|mo|month|day|d)/i);
        if (match) {
          const val = parseFloat(match[1]);
          const unit = match[2].toLowerCase();
          if (unit.startsWith('yr') || unit.startsWith('year')) {
            patientAge = Math.round(val * 365);
          } else if (unit.startsWith('mo')) {
            patientAge = Math.round(val * 30);
          } else {
            patientAge = Math.round(val);
          }
        }
      }
      patientAge = patientAge || 365 * 5; // Default 5 years

      const predictions = await getMLPredictions(currentSignal, patientAge);
      updateMLPanel(predictions);
    }

    // Check ML service on page load
    setTimeout(checkMLService, 1000);

    /**
     * Draw measurement annotations on ECG (PR, QRS, QT intervals)
     * Shows brackets and labels on lead II (best for interval measurement)
     */
    function drawMeasurementAnnotations(ctx, leadSamples, startX, baselineY, pxPerSample, pxPerUv, measurements, sampleRate) {
      if (!showAnnotations || !measurements || !leadSamples) return;

      const mean = leadSamples.reduce((sum, v) => sum + v, 0) / leadSamples.length;

      // Convert ms to samples
      const msToSamples = (ms) => Math.round((ms / 1000) * sampleRate);
      const samplesToX = (samples) => startX + samples * pxPerSample;

      // Find first R peak (simple peak detection in first 2 seconds)
      let rPeakIdx = 0;
      let maxVal = -Infinity;
      const searchWindow = Math.min(msToSamples(2000), leadSamples.length);

      for (let i = msToSamples(100); i < searchWindow; i++) {
        const val = leadSamples[i] - mean;
        if (val > maxVal) {
          maxVal = val;
          rPeakIdx = i;
        }
      }

      if (rPeakIdx === 0) return; // No R peak found

      // Estimate positions based on R peak and measurements
      const prMs = measurements.pr || 160;
      const qrsMs = measurements.qrs || 80;
      const qtMs = measurements.qt || 400;

      // P wave starts before QRS by PR interval
      const qrsStart = rPeakIdx - msToSamples(qrsMs / 2);
      const pWaveStart = qrsStart - msToSamples(prMs - 30); // P wave duration ~30ms overlap
      const qrsEnd = rPeakIdx + msToSamples(qrsMs / 2);
      const tWaveEnd = qrsStart + msToSamples(qtMs);

      // Annotation colors
      const prColor = '#0066CC'; // Blue for PR
      const qrsColor = '#009900'; // Green for QRS
      const qtColor = '#CC6600'; // Orange for QT

      // Draw annotations above waveform
      const annotY = baselineY - 40;
      const markerHeight = 15;

      ctx.save();
      ctx.font = 'bold 9px Arial';
      ctx.textBaseline = 'top';

      // PR interval marker
      if (pWaveStart > 0 && qrsStart > pWaveStart) {
        const prStartX = samplesToX(pWaveStart);
        const prEndX = samplesToX(qrsStart);

        ctx.strokeStyle = prColor;
        ctx.fillStyle = prColor;
        ctx.lineWidth = 1.5;

        // Draw bracket
        ctx.beginPath();
        ctx.moveTo(prStartX, annotY);
        ctx.lineTo(prStartX, annotY + markerHeight);
        ctx.moveTo(prStartX, annotY + markerHeight / 2);
        ctx.lineTo(prEndX, annotY + markerHeight / 2);
        ctx.moveTo(prEndX, annotY);
        ctx.lineTo(prEndX, annotY + markerHeight);
        ctx.stroke();

        // Label
        const prLabel = `PR ${prMs}ms`;
        ctx.textAlign = 'center';
        ctx.fillText(prLabel, (prStartX + prEndX) / 2, annotY - 10);
      }

      // QRS duration marker (slightly below PR)
      if (qrsStart > 0 && qrsEnd > qrsStart) {
        const qrsStartX = samplesToX(qrsStart);
        const qrsEndX = samplesToX(qrsEnd);
        const qrsAnnotY = annotY + 20;

        ctx.strokeStyle = qrsColor;
        ctx.fillStyle = qrsColor;
        ctx.lineWidth = 2;

        // Draw bracket
        ctx.beginPath();
        ctx.moveTo(qrsStartX, qrsAnnotY);
        ctx.lineTo(qrsStartX, qrsAnnotY + markerHeight);
        ctx.moveTo(qrsStartX, qrsAnnotY + markerHeight / 2);
        ctx.lineTo(qrsEndX, qrsAnnotY + markerHeight / 2);
        ctx.moveTo(qrsEndX, qrsAnnotY);
        ctx.lineTo(qrsEndX, qrsAnnotY + markerHeight);
        ctx.stroke();

        // Label
        const qrsLabel = `QRS ${qrsMs}ms`;
        ctx.textAlign = 'center';
        ctx.fillText(qrsLabel, (qrsStartX + qrsEndX) / 2, qrsAnnotY - 10);
      }

      // QT interval marker (below waveform)
      if (qrsStart > 0 && tWaveEnd > qrsStart) {
        const qtStartX = samplesToX(qrsStart);
        const qtEndX = samplesToX(tWaveEnd);
        const qtAnnotY = baselineY + 25;

        ctx.strokeStyle = qtColor;
        ctx.fillStyle = qtColor;
        ctx.lineWidth = 1.5;

        // Draw bracket
        ctx.beginPath();
        ctx.moveTo(qtStartX, qtAnnotY);
        ctx.lineTo(qtStartX, qtAnnotY + markerHeight);
        ctx.moveTo(qtStartX, qtAnnotY + markerHeight / 2);
        ctx.lineTo(qtEndX, qtAnnotY + markerHeight / 2);
        ctx.moveTo(qtEndX, qtAnnotY);
        ctx.lineTo(qtEndX, qtAnnotY + markerHeight);
        ctx.stroke();

        // Label
        const qtcMs = measurements.qtc || 420;
        const qtLabel = `QT ${qtMs}ms (QTc ${qtcMs})`;
        ctx.textAlign = 'center';
        ctx.fillText(qtLabel, (qtStartX + qtEndX) / 2, qtAnnotY + markerHeight + 2);
      }

      ctx.restore();
    }

    function toggleAnnotations() {
      showAnnotations = !showAnnotations;
      window.renderECG();

      // Update toolbar button state
      const btn = document.getElementById('btn-annotations');
      if (btn) {
        btn.classList.toggle('active', showAnnotations);
      }
    }
    window.toggleAnnotations = toggleAnnotations;

    function updateUI(patient, measurements) {
      // Update left panel fields
      document.getElementById('patient-id').value = patient.mrn || '---';
      document.getElementById('patient-name').value = patient.name || '---';
      document.getElementById('patient-datetime').value = patient.testDateTime || new Date().toLocaleString();
      document.getElementById('patient-location').value = patient.location || '---';

      // Update title bar
      document.getElementById('title-patient').textContent = patient.name || '---';
      document.getElementById('title-datetime').textContent = patient.testDateTime || new Date().toLocaleString();

      // Update status bar
      document.getElementById('status-id').textContent = patient.mrn || '---';
      document.getElementById('status-acquired').textContent = patient.testDateTime || new Date().toLocaleString();

      // Update measurements with MUSE-style color coding
      const normals = currentPediatricContext?.normals;

      // Helper to set value with color coding
      const setMeasurement = (id, value, normalRange, rangeId) => {
        const input = document.getElementById(id);
        if (!input) return;

        const displayValue = value != null ? Math.round(value) : '--';
        input.value = displayValue;

        // Apply color coding based on classification
        input.classList.remove('meas-normal', 'meas-borderline', 'meas-abnormal');
        if (value != null && normalRange) {
          const classification = classifyValue(value, normalRange);
          if (classification === 'low' || classification === 'high') {
            input.classList.add('meas-abnormal');
          } else if (classification === 'borderline_low' || classification === 'borderline_high') {
            input.classList.add('meas-borderline');
          } else {
            input.classList.add('meas-normal');
          }
        }

        // Show range if element exists
        if (rangeId && normalRange) {
          const rangeEl = document.getElementById(rangeId);
          if (rangeEl) rangeEl.textContent = `(${normalRange.p2}-${normalRange.p98})`;
        }
      };

      setMeasurement('meas-vent-rate', measurements.hr, normals?.heartRate, 'meas-vent-range');
      setMeasurement('meas-pr', measurements.pr, normals?.prInterval, 'meas-pr-range');
      setMeasurement('meas-qrs', measurements.qrs, normals?.qrsDuration, 'meas-qrs-range');
      setMeasurement('meas-qt', measurements.qt, null, null);
      setMeasurement('meas-qtc', measurements.qtc, normals?.qtcBazett, 'meas-qtc-range');
      setMeasurement('meas-p-axis', measurements.pAxis, null, null);
      setMeasurement('meas-qrs-axis', measurements.qrsAxis, normals?.qrsAxis, null);
      setMeasurement('meas-t-axis', measurements.tAxis, null, null);

      // RV5/SV1 voltages (for LVH/RVH criteria)
      const rv5El = document.getElementById('meas-rv5');
      const sv1El = document.getElementById('meas-sv1');
      if (rv5El) rv5El.value = measurements.rv5 ? (measurements.rv5 / 1000).toFixed(1) : '--';
      if (sv1El) sv1El.value = measurements.sv1 ? (measurements.sv1 / 1000).toFixed(1) : '--';

      // Update interpretation panel (above ECG)
      const interpContainer = document.getElementById('ecg-interpretation-text');
      const interpretation = patient.interpretation || ['Normal sinus rhythm'];
      if (interpContainer) {
        interpContainer.innerHTML = interpretation.map(line => {
          const isAbnormal = line.toLowerCase().includes('abnormal') ||
                            line.toLowerCase().includes('elevation') ||
                            line.toLowerCase().includes('hypertrophy') ||
                            line.toLowerCase().includes('lvh') ||
                            line.toLowerCase().includes('rvh');
          return `<div class="interp-line ${isAbnormal ? 'abnormal' : ''}">${line}</div>`;
        }).join('');
      }

      // Update confirmation status
      const badge = document.getElementById('confirm-status');
      if (badge) {
        badge.textContent = patient.confirmed ? 'CONFIRMED' : 'UNCONFIRMED';
        badge.className = patient.confirmed ? 'badge badge-confirmed' : 'badge badge-unconfirmed';
      }
    }

    // Update the Measurements tab table with actual values and age-appropriate ranges
    function updateMeasurementsTable(measurements) {
      const tbody = document.getElementById('measurements-table-body');
      if (!tbody) return;

      // Get age-appropriate normal ranges if available
      const normals = currentPediatricContext?.normals;

      // Helper to format normal range
      const formatRange = (range) => {
        if (!range) return '---';
        return `${range.p2}-${range.p98}`;
      };

      // Build table rows with actual measurements
      const rows = [
        {
          param: 'Ventricular Rate',
          value: Math.round(measurements.hr) || '---',
          unit: 'BPM',
          range: normals ? formatRange(normals.heartRate) : '60-100'
        },
        {
          param: 'Atrial Rate',
          value: Math.round(measurements.hr) || '---',
          unit: 'BPM',
          range: normals ? formatRange(normals.heartRate) : '60-100'
        },
        {
          param: 'PR Interval',
          value: Math.round(measurements.pr) || '---',
          unit: 'ms',
          range: normals ? formatRange(normals.prInterval) : '120-200'
        },
        {
          param: 'QRS Duration',
          value: Math.round(measurements.qrs) || '---',
          unit: 'ms',
          range: normals ? formatRange(normals.qrsDuration) : '60-100'
        },
        {
          param: 'QT Interval',
          value: Math.round(measurements.qt) || '---',
          unit: 'ms',
          range: '---' // QT varies with HR, show QTc instead
        },
        {
          param: 'QTc (Bazett)',
          value: Math.round(measurements.qtc) || '---',
          unit: 'ms',
          range: normals ? formatRange(normals.qtcBazett) : '350-450'
        },
        {
          param: 'P Axis',
          value: Math.round(measurements.pAxis) || '---',
          unit: 'deg',
          range: '0-75'
        },
        {
          param: 'QRS Axis',
          value: Math.round(measurements.qrsAxis) || '---',
          unit: 'deg',
          range: normals ? formatRange(normals.qrsAxis) : '-30-90'
        },
        {
          param: 'T Axis',
          value: Math.round(measurements.tAxis) || '---',
          unit: 'deg',
          range: '---'
        },
        {
          param: 'RR Interval',
          value: Math.round(measurements.rr) || Math.round(60000 / (measurements.hr || 75)),
          unit: 'ms',
          range: '---'
        }
      ];

      tbody.innerHTML = rows.map(row =>
        `<tr>
          <td>${row.param}</td>
          <td>${row.value}</td>
          <td>${row.unit}</td>
          <td>${row.range}</td>
        </tr>`
      ).join('');
    }

    window.renderECG = function() {
      const canvas = document.getElementById('ecg-canvas');
      const ctx = canvas.getContext('2d');

      const formatSelect = document.getElementById('format-select');
      const speedSelect = document.getElementById('speed-select');
      const gainSelect = document.getElementById('gain-select');

      const is15Lead = formatSelect.value === '15';
      const paperSpeed = parseInt(speedSelect.value);
      const gain = parseInt(gainSelect.value);

      const signal = currentSignal || sampleECG;
      const patient = currentPatient || {
        name: 'DOE, JANE',
        mrn: '12345678',
        dob: '03/15/2021',
        age: '3 yr',
        sex: 'F',
        location: 'Peds Cardiology Clinic',
        room: 'Exam 4',
        referredBy: 'Smith, John MD',
        technician: 'Johnson, Mary RT',
        testDateTime: new Date().toLocaleString(),
        interpretation: [
          'Normal sinus rhythm',
          'Normal ECG for age',
          'Right axis deviation (normal for age)',
          'Dominant R wave in V1 (normal for age)',
          'RSR\' pattern in V1 (normal variant)'
        ],
        orderId: ecgId,
        confirmed: false,
      };

      // Calculate measurements from signal if not already set
      let measurements = currentMeasurements;
      if (!measurements && signal && signal.leads) {
        const leadII = signal.leads['II'] || [];
        const leadI = signal.leads['I'] || [];
        const leadAVF = signal.leads['aVF'] || [];

        if (leadII.length > 0) {
          const calculated = calculateECGMeasurements(leadII, leadI, leadAVF, signal.sampleRate);
          measurements = {
            hr: calculated.hr,
            pr: calculated.pr,
            qrs: calculated.qrs,
            qt: calculated.qt,
            qtc: calculated.qtc,
            pAxis: calculated.pAxis,
            qrsAxis: calculated.qrsAxis,
            tAxis: calculated.tAxis,
            rr: calculated.rr,
          };
          currentMeasurements = measurements; // Cache for next render
        }
      }

      // Fallback to defaults
      measurements = measurements || {
        hr: 130, pr: 110, qrs: 72, qt: 320, qtc: 410,
        pAxis: 65, qrsAxis: 80, tAxis: 56,
      };

      updateUI(patient, measurements);
      updateMeasurementsTable(measurements);

      const dpi = 96;
      const footerHeight = 20;
      const width = is15Lead ? 1400 : 1200;
      const height = 750;

      canvas.width = width;
      canvas.height = height;
      canvas.style.transform = `scale(${currentZoom})`;
      canvas.style.transformOrigin = 'top left';

      const pxPerMm = dpi / 25.4;
      const largeBoxPx = pxPerMm * 5;

      // Grid covers the full canvas (minus footer)
      const gridArea = {
        x: 0,
        y: 0,
        width: width,
        height: height - footerHeight,
      };

      // Always fill with pink ECG paper background first
      ctx.fillStyle = ECG_COLORS.background;
      ctx.fillRect(0, 0, width, height);

      const gridRenderer = new GridRenderer(ctx, { dpi });
      gridRenderer.render(gridArea.x, gridArea.y, gridArea.width, gridArea.height, showGrid);
      const metrics = gridRenderer.getMetrics();

      if (!signal) return;

      const leadLayout = is15Lead ? LEAD_LAYOUT_15 : LEAD_LAYOUT_12;
      const rhythmLeads = is15Lead ? RHYTHM_LEADS_15 : RHYTHM_LEADS_12;
      const numRows = 3;
      const numCols = is15Lead ? 5 : 4;
      const numRhythmStrips = rhythmLeads.length;

      const totalLeadRows = numRows + numRhythmStrips;
      // Evenly distribute rows and columns across the grid
      const rowSpacing = gridArea.height / totalLeadRows;
      const colWidth = gridArea.width / numCols;

      const secondsPerColumn = is15Lead ? 2.0 : 2.5;
      const rhythmSeconds = 10;
      const samplesPerColumn = Math.floor(signal.sampleRate * secondsPerColumn);
      const rhythmSamples = Math.floor(signal.sampleRate * rhythmSeconds);

      const pxPerSecond = metrics.pxPerMm * paperSpeed;
      const pxPerSample = pxPerSecond / signal.sampleRate;

      const baselineYs = [];
      for (let row = 0; row < totalLeadRows; row++) {
        // Center baseline in each row
        const baselineY = gridArea.y + rowSpacing * (row + 0.5);
        baselineYs.push(baselineY);
      }

      const rhythmStartY = gridArea.y + numRows * rowSpacing;

      drawSeparators(ctx, gridArea, numCols, numRows, rowSpacing, colWidth, rhythmStartY);

      for (let row = 0; row < numRows; row++) {
        const baselineY = baselineYs[row];

        for (let col = 0; col < numCols; col++) {
          const lead = leadLayout[row][col];

          if (!lead || lead === '') continue;

          const colStartX = gridArea.x + col * colWidth;

          const pxPerUv = metrics.pxPerMm * (gain / 1000);
          const samples = signal.leads[lead]?.slice(0, samplesPerColumn) || [];

          if (col === 0) {
            drawCalibrationPulse(ctx, colStartX + 3, baselineY, metrics.pxPerMm, gain);
          }

          const waveformOffset = col === 0 ? largeBoxPx * 2 : largeBoxPx * 0.5;
          const waveformStartX = colStartX + waveformOffset;
          const waveformWidth = colWidth - waveformOffset - 5;

          renderWaveform(ctx, samples, waveformStartX, baselineY, pxPerSample, pxPerUv, waveformWidth);

          // Draw lead label - positioned at top of each cell
          ctx.font = 'bold 11px Arial, sans-serif';
          ctx.fillStyle = ECG_COLORS.leadLabel;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'alphabetic';
          const labelX = colStartX + 5;
          const labelY = baselineY - rowSpacing * 0.35;
          ctx.fillText(lead, labelX, labelY);
        }
      }

      for (let i = 0; i < numRhythmStrips; i++) {
        const rhythmLead = rhythmLeads[i];
        const rhythmBaselineY = baselineYs[numRows + i];
        const rhythmData = signal.leads[rhythmLead] || [];
        const rhythmPxPerUv = metrics.pxPerMm * (gain / 1000);

        drawCalibrationPulse(ctx, gridArea.x + 3, rhythmBaselineY, metrics.pxPerMm, gain);

        const rhythmWaveformStart = gridArea.x + largeBoxPx * 2;
        renderWaveform(ctx, rhythmData.slice(0, rhythmSamples), rhythmWaveformStart, rhythmBaselineY, pxPerSample, rhythmPxPerUv, gridArea.width - largeBoxPx * 2 - 5);

        // Draw measurement annotations on lead II (best for interval measurement)
        if (rhythmLead === 'II') {
          drawMeasurementAnnotations(ctx, rhythmData.slice(0, rhythmSamples), rhythmWaveformStart, rhythmBaselineY, pxPerSample, rhythmPxPerUv, measurements, signal.sampleRate);
        }

        // Draw rhythm strip label
        ctx.font = 'bold 11px Arial, sans-serif';
        ctx.fillStyle = ECG_COLORS.leadLabel;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'alphabetic';
        ctx.fillText(rhythmLead, gridArea.x + 5, rhythmBaselineY - rowSpacing * 0.35);
      }

      renderFooter(ctx, gridArea, height, paperSpeed, gain, is15Lead, ecgId);

      const wrapper = document.querySelector('.ecg-canvas-wrapper');
      if (wrapper) {
        wrapper.scrollLeft = 0;
      }
    };

    function renderHeader(ctx, patient, measurements, width, headerHeight) {
      // MUSE-authentic header layout
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, headerHeight);

      const leftMargin = 12;
      const col2Start = 200;  // Measurements column
      const col3Start = 400;  // More measurements
      const col4Start = width - 320;  // Right side info

      ctx.fillStyle = '#000000';
      ctx.textBaseline = 'top';

      // === LEFT COLUMN - Patient Demographics ===
      ctx.textAlign = 'left';

      // Patient name (large, bold)
      ctx.font = 'bold 13px Arial, sans-serif';
      ctx.fillText(patient.name || 'DOE, JANE', leftMargin, 4);

      // Patient details
      ctx.font = '10px Arial, sans-serif';
      ctx.fillText(`ID: ${patient.mrn || '---'}`, leftMargin, 20);
      ctx.fillText(`DOB: ${patient.dob || '---'}`, leftMargin, 32);
      ctx.fillText(`Age: ${patient.age || '---'}  Sex: ${patient.sex || '---'}`, leftMargin, 44);
      ctx.fillText(`Location: ${patient.location || '---'}`, leftMargin, 56);

      // === COLUMN 2 - Measurements ===
      ctx.font = 'bold 10px Arial, sans-serif';
      ctx.fillText('Vent. rate', col2Start, 4);
      ctx.fillText('PR interval', col2Start, 18);
      ctx.fillText('QRS duration', col2Start, 32);
      ctx.fillText('QT/QTc', col2Start, 46);
      ctx.fillText('P-R-T axes', col2Start, 60);

      ctx.font = '10px Arial, sans-serif';
      const measX = col2Start + 80;
      ctx.fillText(`${measurements.hr || '---'} BPM`, measX, 4);
      ctx.fillText(`${measurements.pr || '---'} ms`, measX, 18);
      ctx.fillText(`${measurements.qrs || '---'} ms`, measX, 32);
      ctx.fillText(`${measurements.qt || '---'}/${measurements.qtc || '---'} ms`, measX, 46);

      // Draw axis values with small colored indicators
      const axisY = 60;
      ctx.font = '10px Arial, sans-serif';
      ctx.fillStyle = '#008800';
      ctx.fillText(`${measurements.pAxis || '---'}¬∞`, measX, axisY);
      ctx.fillStyle = '#CC0000';
      ctx.fillText(`${measurements.qrsAxis || '---'}¬∞`, measX + 35, axisY);
      ctx.fillStyle = '#0000CC';
      ctx.fillText(`${measurements.tAxis || '---'}¬∞`, measX + 70, axisY);
      ctx.fillStyle = '#000000';

      // === COLUMN 3 - Additional Info ===
      ctx.font = '10px Arial, sans-serif';
      ctx.fillText(`Referred by: ${patient.referredBy || 'Not specified'}`, col3Start, 4);
      ctx.fillText(`Technician: ${patient.technician || 'SYSTEM'}`, col3Start, 18);
      ctx.fillText(`Room: ${patient.room || '---'}`, col3Start, 32);
      ctx.fillText(`Order #: ${patient.orderId || ecgId}`, col3Start, 46);

      // === RIGHT COLUMN - Date/Time and Status ===
      ctx.textAlign = 'right';
      ctx.font = 'bold 11px Arial, sans-serif';
      ctx.fillText(patient.testDateTime || new Date().toLocaleString(), width - 12, 4);

      // Confirmation status badge
      const isConfirmed = patient.confirmed || false;
      const statusText = isConfirmed ? 'CONFIRMED' : 'UNCONFIRMED';
      const statusColor = isConfirmed ? '#008000' : '#FF6600';

      ctx.font = 'bold 9px Arial, sans-serif';
      const statusWidth = ctx.measureText(statusText).width + 8;
      const statusX = width - 12 - statusWidth;

      ctx.fillStyle = statusColor;
      ctx.fillRect(statusX, 18, statusWidth, 14);
      ctx.fillStyle = '#FFFFFF';
      ctx.textAlign = 'center';
      ctx.fillText(statusText, statusX + statusWidth / 2, 20);

      // Device info
      ctx.textAlign = 'right';
      ctx.fillStyle = '#666666';
      ctx.font = '9px Arial, sans-serif';
      ctx.fillText('GE MUSE v9.0 - Pediatric', width - 12, 36);
      ctx.fillText('GEMUSE Demo System', width - 12, 48);

      // Bottom border
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, headerHeight - 1);
      ctx.lineTo(width, headerHeight - 1);
      ctx.stroke();
    }

    // Render interpretation box ON the ECG grid (top-right corner)
    function renderInterpretationBox(ctx, gridArea, patient, measurements) {
      const boxWidth = 280;
      const boxHeight = 100;
      const boxX = gridArea.x + gridArea.width - boxWidth - 10;
      const boxY = gridArea.y + 10;
      const padding = 8;

      // Semi-transparent white background
      ctx.fillStyle = 'rgba(255, 255, 255, 0.92)';
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

      // Border
      ctx.strokeStyle = '#000080';
      ctx.lineWidth = 1.5;
      ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

      // Title bar
      ctx.fillStyle = '#000080';
      ctx.fillRect(boxX, boxY, boxWidth, 16);
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 10px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('INTERPRETATION', boxX + boxWidth / 2, boxY + 8);

      // Interpretation lines
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.font = '9px Arial, sans-serif';

      const interpretation = patient.interpretation || ['Normal sinus rhythm', 'Normal ECG'];
      let yPos = boxY + 20;

      interpretation.forEach((line, i) => {
        if (yPos < boxY + boxHeight - 10) {
          // Check for abnormal findings
          const isAbnormal = line.toLowerCase().includes('abnormal') ||
                            line.toLowerCase().includes('elevation') ||
                            line.toLowerCase().includes('hypertrophy') ||
                            line.toLowerCase().includes('infarct');

          ctx.fillStyle = isAbnormal ? '#CC0000' : '#000000';

          // Wrap long lines
          const maxWidth = boxWidth - padding * 2;
          if (ctx.measureText(line).width > maxWidth) {
            const words = line.split(' ');
            let currentLine = '';
            for (const word of words) {
              const testLine = currentLine + word + ' ';
              if (ctx.measureText(testLine).width > maxWidth) {
                ctx.fillText(currentLine.trim(), boxX + padding, yPos);
                yPos += 11;
                currentLine = word + ' ';
              } else {
                currentLine = testLine;
              }
            }
            ctx.fillText(currentLine.trim(), boxX + padding, yPos);
          } else {
            ctx.fillText(line, boxX + padding, yPos);
          }
          yPos += 11;
        }
      });
    }

    // Render median beat display (averaged beat in small box)
    function renderMedianBeat(ctx, gridArea, signal, metrics, gain) {
      const boxWidth = 80;
      const boxHeight = 60;
      const boxX = gridArea.x + 10;
      const boxY = gridArea.y + 10;

      // Background
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

      // Border
      ctx.strokeStyle = '#000080';
      ctx.lineWidth = 1;
      ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

      // Title
      ctx.fillStyle = '#000080';
      ctx.font = 'bold 8px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('MEDIAN BEAT', boxX + boxWidth / 2, boxY + 2);

      // Draw a simplified median beat from Lead II
      if (signal && signal.leads && signal.leads['II']) {
        const leadII = signal.leads['II'];
        const beatsToAverage = 3;
        const samplesPerBeat = Math.floor(signal.sampleRate * 0.8); // ~0.8 sec per beat at 75 bpm

        // Get first few beats and average
        const medianBeat = new Array(samplesPerBeat).fill(0);
        for (let b = 0; b < beatsToAverage && (b + 1) * samplesPerBeat < leadII.length; b++) {
          for (let s = 0; s < samplesPerBeat; s++) {
            medianBeat[s] += leadII[b * samplesPerBeat + s] / beatsToAverage;
          }
        }

        // Render small waveform
        const baselineY = boxY + boxHeight / 2 + 5;
        const scale = 0.3; // Smaller scale for the box
        const pxPerSample = (boxWidth - 10) / samplesPerBeat;
        const pxPerUv = metrics.pxPerMm * (gain / 1000) * scale;

        const mean = medianBeat.reduce((a, b) => a + b, 0) / medianBeat.length;

        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 0; i < medianBeat.length; i++) {
          const x = boxX + 5 + i * pxPerSample;
          const y = baselineY - (medianBeat[i] - mean) * pxPerUv;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      }
    }

    // Render axis arrows display
    function renderAxisDisplay(ctx, gridArea, measurements) {
      const boxWidth = 90;
      const boxHeight = 75;
      const boxX = gridArea.x + 100;
      const boxY = gridArea.y + 10;

      // Background
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

      // Border
      ctx.strokeStyle = '#000080';
      ctx.lineWidth = 1;
      ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

      // Title
      ctx.fillStyle = '#000080';
      ctx.font = 'bold 8px Arial, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('AXES', boxX + boxWidth / 2, boxY + 2);

      const centerX = boxX + boxWidth / 2;
      const centerY = boxY + boxHeight / 2 + 5;
      const radius = 22;

      // Draw reference circle
      ctx.strokeStyle = '#CCCCCC';
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();

      // Draw reference lines (0¬∞, 90¬∞, ¬±180¬∞)
      ctx.beginPath();
      ctx.moveTo(centerX - radius, centerY);
      ctx.lineTo(centerX + radius, centerY);
      ctx.moveTo(centerX, centerY - radius);
      ctx.lineTo(centerX, centerY + radius);
      ctx.stroke();

      // Draw axis arrows
      function drawAxisArrow(angle, color, label) {
        const radians = (angle - 90) * Math.PI / 180; // -90 because 0¬∞ is to the right in ECG
        const endX = centerX + Math.cos(radians) * (radius - 2);
        const endY = centerY + Math.sin(radians) * (radius - 2);

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 2;

        // Line
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(endX, endY);
        ctx.stroke();

        // Arrowhead
        const arrowSize = 4;
        const arrowAngle = Math.atan2(endY - centerY, endX - centerX);
        ctx.beginPath();
        ctx.moveTo(endX, endY);
        ctx.lineTo(endX - arrowSize * Math.cos(arrowAngle - 0.4), endY - arrowSize * Math.sin(arrowAngle - 0.4));
        ctx.lineTo(endX - arrowSize * Math.cos(arrowAngle + 0.4), endY - arrowSize * Math.sin(arrowAngle + 0.4));
        ctx.closePath();
        ctx.fill();

        // Label
        ctx.font = 'bold 7px Arial';
        ctx.textAlign = 'center';
        const labelX = centerX + Math.cos(radians) * (radius + 8);
        const labelY = centerY + Math.sin(radians) * (radius + 8);
        ctx.fillText(label, labelX, labelY + 2);
      }

      // P axis (green), QRS axis (red), T axis (blue)
      if (measurements.pAxis !== undefined) drawAxisArrow(measurements.pAxis, '#008800', 'P');
      if (measurements.qrsAxis !== undefined) drawAxisArrow(measurements.qrsAxis, '#CC0000', 'QRS');
      if (measurements.tAxis !== undefined) drawAxisArrow(measurements.tAxis, '#0000CC', 'T');

      // Labels at bottom
      ctx.font = '7px Arial';
      ctx.fillStyle = '#000000';
      ctx.textAlign = 'center';
      ctx.fillText(`P:${measurements.pAxis}¬∞ QRS:${measurements.qrsAxis}¬∞ T:${measurements.tAxis}¬∞`, centerX, boxY + boxHeight - 3);
    }

    function renderFooter(ctx, gridArea, canvasHeight, paperSpeed, gain, is15Lead, ecgId) {
      const footerY = gridArea.y + gridArea.height + 12;

      ctx.fillStyle = '#000000';
      ctx.font = '9px Arial';

      ctx.textAlign = 'left';
      ctx.fillText(`${paperSpeed} mm/s  ${gain} mm/mV  4 x 2.0ms/150 Hz  ~60 Hz`, gridArea.x + 5, footerY);

      ctx.textAlign = 'center';
      const formatText = is15Lead ? '15-Lead' : '12-Lead';
      ctx.fillText(`${formatText}  QTc: Bazett  EID: ${ecgId}`, gridArea.x + gridArea.width / 2, footerY);

      ctx.textAlign = 'right';
      ctx.fillText('UNCONFIRMED', gridArea.x + gridArea.width - 5, footerY);
    }

    window.downloadPNG = function() {
      const canvas = document.getElementById('ecg-canvas');
      const link = document.createElement('a');
      link.download = `ecg-${ecgId}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    };

    window.zoomIn = function() {
      currentZoom = Math.min(currentZoom + 0.1, 2);
      document.getElementById('ecg-canvas').style.transform = `scale(${currentZoom})`;
      if (calipers) calipers.updateTransform(currentZoom);
    };

    window.zoomOut = function() {
      currentZoom = Math.max(currentZoom - 0.1, 0.5);
      document.getElementById('ecg-canvas').style.transform = `scale(${currentZoom})`;
      if (calipers) calipers.updateTransform(currentZoom);
    };

    window.loadECGFile = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const fileName = file.name.toLowerCase();
        let result;
        let formatName = 'Unknown';

        // Determine format and parse accordingly
        if (fileName.endsWith('.dcm')) {
          // DICOM ECG
          const buffer = await file.arrayBuffer();
          const dicomResult = parseDICOMECG(buffer);
          formatName = 'DICOM ECG';
          result = {
            signal: dicomResult.signal,
            patient: {
              patientId: dicomResult.patient.patientId,
              lastName: dicomResult.patient.patientName.split('^')[0] || 'DOE',
              firstName: dicomResult.patient.patientName.split('^')[1] || 'JOHN',
              age: 0,
              ageUnits: '',
              gender: dicomResult.patient.sex,
              race: '',
            },
            test: {
              acquisitionDate: dicomResult.study.studyDate,
              acquisitionTime: dicomResult.study.studyTime,
              location: dicomResult.study.institutionName,
              site: '',
            },
            diagnosis: { statements: [] },
          };
        } else if (fileName.endsWith('.scp')) {
          // SCP-ECG
          const buffer = await file.arrayBuffer();
          const scpResult = parseSCPECG(buffer);
          formatName = 'SCP-ECG';
          result = {
            signal: scpResult.signal,
            patient: {
              patientId: scpResult.patient.patientId,
              lastName: scpResult.patient.lastName || 'DOE',
              firstName: scpResult.patient.firstName || 'JOHN',
              age: scpResult.patient.age,
              ageUnits: 'Years',
              gender: scpResult.patient.gender,
              race: '',
            },
            test: {
              acquisitionDate: scpResult.test.acquisitionDate,
              acquisitionTime: scpResult.test.acquisitionTime,
              location: scpResult.test.institution,
              site: scpResult.test.department,
            },
            diagnosis: scpResult.diagnosis || { statements: [] },
          };
        } else if (/\.(png|jpg|jpeg|gif|bmp|webp)$/i.test(fileName)) {
          // Image file - use PNG digitizer
          formatName = 'ECG Image (PNG Digitizer)';

          // Show progress indicator
          const statusBar = document.querySelector('.status-bar-right');
          const originalStatus = statusBar.textContent;
          statusBar.textContent = 'Digitizing ECG image...';

          try {
            // Load image as ImageData
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Use parallel ensemble - run ALL AI providers simultaneously, pick best result
            const { EnsembleProvider } = await import('./src/signal/loader/png-digitizer/ai/ensemble.ts');

            const ensemble = new EnsembleProvider({
              apiKeys: {
                anthropic: 'proxy',  // Proxy handles auth
                xai: 'proxy',        // Proxy handles auth
              },
              models: {
                anthropic: 'claude-sonnet-4-20250514',
                xai: 'grok-2-vision-1212',  // Use vision-capable model
              },
              primary: 'anthropic',   // Claude is primary
              fallbacks: ['xai'],     // Grok is fallback
              parallel: true,         // Run all providers at once
              minConfidence: 0.85,    // Accept 85%+ confidence
            });

            statusBar.textContent = 'Digitizing: Running Claude + Grok in parallel...';

            // Get AI analysis
            const aiResult = await ensemble.analyze(imageData);

            statusBar.textContent = `AI Analysis: ${(aiResult.confidence * 100).toFixed(1)}% from ${aiResult.provider}`;

            // Log detailed AI analysis for debugging
            console.log('=== AI ANALYSIS RESULTS ===');
            console.log('Provider:', aiResult.provider);
            console.log('Model:', aiResult.model);
            console.log('Grid Analysis:', {
              pxPerMm: aiResult.analysis.grid.pxPerMm,
              confidence: aiResult.analysis.grid.confidence,
              type: aiResult.analysis.grid.type,
            });
            console.log('Calibration:', {
              gain: aiResult.analysis.calibration.gain,
              paperSpeed: aiResult.analysis.calibration.paperSpeed,
              confidence: aiResult.analysis.calibration.confidence,
            });
            console.log('Panels:', aiResult.analysis.panels.map(p => ({
              lead: p.lead,
              bounds: p.bounds,
              baselineY: p.baselineY,
              labelConfidence: p.labelConfidence,
            })));

            // Extract waveforms using AI guidance
            const { WaveformTracer } = await import('./src/signal/loader/png-digitizer/cv/waveform-tracer.ts');
            const { SignalReconstructor } = await import('./src/signal/loader/png-digitizer/signal/reconstructor.ts');
            const { QualityScorer } = await import('./src/signal/loader/png-digitizer/signal/quality-scorer.ts');

            const tracer = new WaveformTracer(imageData);
            const traces = tracer.traceAllPanels(aiResult.analysis.panels);

            console.log('=== WAVEFORM EXTRACTION ===');
            console.log('Traces extracted:', traces.length);
            traces.forEach(t => {
              console.log(`Lead ${t.lead}: ${t.xPixels.length} points, baseline=${t.baselineY.toFixed(0)}, gaps=${t.gaps.length}`);
            });

            if (traces.length === 0) {
              throw new Error('No waveforms could be extracted from image');
            }

            const reconstructor = new SignalReconstructor(
              aiResult.analysis.calibration,
              aiResult.analysis.grid,
              { targetSampleRate: 500 }
            );
            const signal = reconstructor.reconstruct(traces);

            console.log('=== SIGNAL RECONSTRUCTION ===');
            console.log('Sample rate:', signal.sampleRate);
            console.log('Duration:', signal.duration);
            console.log('Leads:', Object.keys(signal.leads));
            for (const [lead, samples] of Object.entries(signal.leads)) {
              if (samples && samples.length > 0) {
                const min = Math.min(...samples);
                const max = Math.max(...samples);
                const mean = samples.reduce((a, b) => a + b, 0) / samples.length;
                console.log(`  ${lead}: ${samples.length} samples, range ${min.toFixed(0)} to ${max.toFixed(0)} ¬µV, mean=${mean.toFixed(0)}`);
              }
            }

            const scorer = new QualityScorer();
            const quality = scorer.assess(signal, traces, aiResult.analysis);

            console.log('=== QUALITY ASSESSMENT ===');
            console.log('Overall:', (quality.overall * 100).toFixed(1) + '%');
            console.log('Per-lead:', quality.perLead);
            console.log('Issues:', quality.issues);

            const digitizeResult = {
              success: true,
              signal,
              confidence: quality.overall,
              successTier: 3, // Ensemble
              provider: aiResult.provider,
            };

            if (!digitizeResult.success || !digitizeResult.signal) {
              throw new Error(digitizeResult.issues?.map(i => i.message).join(', ') || 'Digitization failed');
            }

            // Show confidence and tier info
            const confidence = (digitizeResult.confidence * 100).toFixed(1);
            const leadsFound = Object.keys(digitizeResult.signal.leads).length;
            const tierNames = ['', 'Claude Sonnet', 'Claude Opus/Grok', 'Ensemble', 'User-Assisted'];
            const tierName = tierNames[digitizeResult.successTier] || 'AI';
            statusBar.textContent = `Digitized: ${confidence}% (${tierName}), ${leadsFound}/12 leads`;

            console.log('Digitization complete:', {
              confidence: confidence + '%',
              tier: digitizeResult.successTier,
              tierName,
              leads: leadsFound,
              attempts: digitizeResult.totalAttempts,
              tierResults: digitizeResult.tierResults,
            });

            result = {
              signal: digitizeResult.signal,
              patient: {
                patientId: 'IMG-' + Date.now(),
                lastName: 'DIGITIZED',
                firstName: 'ECG',
                age: 0,
                ageUnits: '',
                gender: '',
                race: '',
              },
              test: {
                acquisitionDate: new Date().toISOString().slice(0, 10),
                acquisitionTime: new Date().toISOString().slice(11, 19),
                location: `PNG Digitizer (${tierName})`,
                site: `${confidence}% confidence`,
              },
              diagnosis: { statements: [`Digitized from image with ${confidence}% confidence using ${tierName}`] },
            };

            // Reset status after delay
            setTimeout(() => {
              statusBar.textContent = originalStatus;
            }, 5000);

          } catch (digitizeError) {
            statusBar.textContent = originalStatus;
            throw new Error(`Image digitization failed: ${digitizeError.message}`);
          }
        } else {
          // XML format - detect which one
          const text = await file.text();
          const xmlFormat = detectXMLFormat(text);

          if (xmlFormat === 'hl7') {
            const hl7Result = parseHL7aECG(text);
            formatName = 'HL7 aECG';
            result = {
              signal: hl7Result.signal,
              patient: {
                patientId: hl7Result.patient.patientId,
                lastName: hl7Result.patient.lastName || 'DOE',
                firstName: hl7Result.patient.firstName || 'JOHN',
                age: 0,
                ageUnits: '',
                gender: hl7Result.patient.gender,
                race: '',
              },
              test: {
                acquisitionDate: hl7Result.test.effectiveTime.slice(0, 10),
                acquisitionTime: hl7Result.test.effectiveTime.slice(11, 19),
                location: '',
                site: '',
              },
              diagnosis: hl7Result.diagnosis || { statements: [] },
            };
          } else if (xmlFormat === 'philips') {
            const philipsResult = parsePhilipsXML(text);
            formatName = 'Philips XML';
            result = {
              signal: philipsResult.signal,
              patient: {
                patientId: philipsResult.patient.patientId,
                lastName: philipsResult.patient.lastName || 'DOE',
                firstName: philipsResult.patient.firstName || 'JOHN',
                age: philipsResult.patient.age,
                ageUnits: 'Years',
                gender: philipsResult.patient.gender,
                race: '',
              },
              test: {
                acquisitionDate: philipsResult.test.acquisitionDate,
                acquisitionTime: philipsResult.test.acquisitionTime,
                location: philipsResult.test.location,
                site: philipsResult.test.site,
              },
              diagnosis: { statements: [] },
            };
          } else {
            // Default to Muse XML
            const museResult = parseMuseXML(text);
            formatName = 'GE Muse XML';
            result = {
              signal: museResult.signal,
              patient: museResult.patient,
              test: museResult.test,
              diagnosis: museResult.diagnosis,
            };
          }
        }

        // Map signal data
        currentSignal = {
          sampleRate: result.signal.sampleRate,
          duration: result.signal.duration,
          leads: result.signal.leads,
        };

        // Generate ECG ID
        const dateStr = result.test.acquisitionDate?.replace(/[-\/]/g, '') || new Date().toISOString().slice(0, 10).replace(/-/g, '');
        ecgId = `ECG-${result.patient.patientId || 'UNKNOWN'}-${dateStr}`;

        // Map patient data
        const ageDisplay = result.patient.age ?
          `${result.patient.age} ${result.patient.ageUnits || 'Years'}` : '---';

        const acqDateTime = result.test.acquisitionDate && result.test.acquisitionTime ?
          `${result.test.acquisitionDate} ${result.test.acquisitionTime}` : new Date().toLocaleString();

        currentPatient = {
          name: `${result.patient.lastName || 'DOE'}, ${result.patient.firstName || 'JOHN'}`,
          mrn: result.patient.patientId || '---',
          dob: '---',
          age: ageDisplay,
          sex: result.patient.gender === 'FEMALE' || result.patient.gender === 'F' ? 'F' :
               (result.patient.gender === 'MALE' || result.patient.gender === 'M' ? 'M' : 'U'),
          location: result.test.location || result.test.site || '---',
          testDateTime: acqDateTime,
          interpretation: result.diagnosis.statements?.length > 0 ? result.diagnosis.statements : ['Normal sinus rhythm'],
          orderId: ecgId,
          race: result.patient.race || '---',
        };

        // Calculate measurements
        const leadII = result.signal.leads['II'] || [];
        const leadI = result.signal.leads['I'] || [];
        const leadAVF = result.signal.leads['aVF'] || [];

        if (leadII.length > 0) {
          const calculated = calculateECGMeasurements(leadII, leadI, leadAVF, result.signal.sampleRate);
          currentMeasurements = {
            hr: calculated.hr,
            pr: calculated.pr,
            qrs: calculated.qrs,
            qt: calculated.qt,
            qtc: calculated.qtc,
            pAxis: calculated.pAxis,
            qrsAxis: calculated.qrsAxis,
            tAxis: calculated.tAxis,
            rr: calculated.rr,
          };
        } else {
          currentMeasurements = {
            hr: 75, pr: 160, qrs: 80, qt: 400, qtc: 420,
            pAxis: 60, qrsAxis: 60, tAxis: 40,
          };
        }

        updatePatientDisplay();
        resetConfirmationUI(ecgId);
        showECGViewer();
        window.renderECG();

        // Run ML analysis
        analyzeWithML();

        console.log(`Loaded ${formatName}:`, {
          patient: result.patient,
          test: result.test,
          signalInfo: {
            sampleRate: result.signal.sampleRate,
            duration: result.signal.duration,
            leads: Object.keys(result.signal.leads),
          }
        });
      } catch (error) {
        console.error('Error loading ECG file:', error);
        alert('Error loading ECG file: ' + error.message);
      }
    };

    function updatePatientDisplay() {
      if (!currentPatient) return;

      // Update left panel fields
      document.getElementById('patient-id').value = currentPatient.mrn;
      document.getElementById('patient-name').value = currentPatient.name;
      document.getElementById('patient-datetime').value = currentPatient.testDateTime;
      document.getElementById('patient-location').value = currentPatient.location;

      // Update title bar
      document.getElementById('title-patient').textContent = currentPatient.name;
      document.getElementById('title-datetime').textContent = currentPatient.testDateTime;

      // Update status bar
      document.getElementById('status-id').textContent = currentPatient.mrn;
      document.getElementById('status-acquired').textContent = currentPatient.testDateTime;

      // Update interpretation panel
      const interpPanel = document.getElementById('ecg-interpretation-text');
      if (interpPanel && currentPatient.interpretation) {
        interpPanel.innerHTML = currentPatient.interpretation.map(s => `<div>${s}</div>`).join('');
      }
    }

    function renderRhythmStrips() {
      const canvas = document.getElementById('rhythm-canvas');
      const ctx = canvas.getContext('2d');

      const signal = currentSignal || sampleECG;
      const gain = parseInt(document.getElementById('gain-select').value);
      const paperSpeed = parseInt(document.getElementById('speed-select').value);

      const dpi = 96;
      const width = 1400;
      const height = 600;

      canvas.width = width;
      canvas.height = height;

      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, height);

      const pxPerMm = dpi / 25.4;
      const largeBoxPx = pxPerMm * 5;

      const gridRenderer = new GridRenderer(ctx, { dpi });
      gridRenderer.render(0, 0, width, height);
      const metrics = gridRenderer.getMetrics();

      const pxPerSecond = metrics.pxPerMm * paperSpeed;
      const pxPerSample = pxPerSecond / signal.sampleRate;
      const pxPerUv = metrics.pxPerMm * (gain / 1000);

      const allLeads = ['I', 'II', 'III', 'aVR', 'aVL', 'aVF', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6'];
      const rowHeight = height / 12;

      allLeads.forEach((lead, i) => {
        const baselineY = rowHeight * i + rowHeight / 2;
        const samples = signal.leads[lead] || [];

        ctx.font = 'bold 9px Arial';
        ctx.fillStyle = ECG_COLORS.leadLabel;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(lead, 5, baselineY);

        renderWaveform(ctx, samples, 30, baselineY, pxPerSample, pxPerUv, width - 40);
      });
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.classList.contains('disabled')) return;

        const tabName = tab.dataset.tab;

        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const targetContent = document.getElementById(`content-${tabName}`);
        if (targetContent) {
          targetContent.classList.add('active');
        }

        if (tabName === 'rhythm') {
          renderRhythmStrips();
        }
        if (tabName === 'history') {
          updateHistoryList();
        }
      });
    });

    function updateHistoryList() {
      const historyDiv = document.getElementById('history-list');
      const savedECGs = getSavedECGList();

      if (savedECGs.length === 0) {
        historyDiv.innerHTML = 'No ECG history available.<br><br>Use <b>File > Save</b> or click the <b>Save</b> button to save ECGs.';
        return;
      }

      let html = '<table class="measurements-table" style="width: auto;"><thead><tr><th>ECG ID</th><th>Saved</th><th>Action</th></tr></thead><tbody>';

      savedECGs.forEach(id => {
        const data = localStorage.getItem('peds_ecg_' + id);
        let savedAt = '---';
        try {
          const parsed = JSON.parse(data);
          if (parsed.savedAt) {
            savedAt = new Date(parsed.savedAt).toLocaleString();
          }
        } catch (e) {}

        const isCurrent = id === ecgId ? ' (current)' : '';
        html += `<tr>
          <td><b>${id}</b>${isCurrent}</td>
          <td>${savedAt}</td>
          <td>
            <button onclick="loadSavedECG('${id}')" style="margin-right:4px;">Load</button>
            <button onclick="deleteSavedECG('${id}')">Delete</button>
          </td>
        </tr>`;
      });

      html += '</tbody></table>';
      historyDiv.innerHTML = html;
    }

    window.deleteSavedECG = function(id) {
      if (confirm('Delete ECG: ' + id + '?')) {
        localStorage.removeItem('peds_ecg_' + id);
        updateHistoryList();
      }
    };

    window.loadSavedECG = loadSavedECG;

    // Toolbar button handlers
    document.getElementById('btn-open').addEventListener('click', () => {
      document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', window.loadECGFile);

    document.getElementById('btn-print').addEventListener('click', () => {
      showPrintPreview();
    });

    document.getElementById('btn-pdf').addEventListener('click', exportPDF);

    document.getElementById('btn-zoom-in').addEventListener('click', window.zoomIn);
    document.getElementById('btn-zoom-out').addEventListener('click', window.zoomOut);

    document.getElementById('btn-refresh').addEventListener('click', () => {
      currentSignal = null;
      currentPatient = null;
      currentMeasurements = null;
      window.renderECG();
    });

    // Generate and load a synthetic ECG image for testing PNG digitizer
    document.getElementById('btn-sample-ecg').addEventListener('click', async () => {
      const statusBar = document.querySelector('.status-bar-right');
      const originalStatus = statusBar.textContent;

      try {
        statusBar.textContent = 'Generating sample ECG image...';

        // Create a synthetic 12-lead ECG image
        const canvas = document.createElement('canvas');
        canvas.width = 1200;
        canvas.height = 900;
        const ctx = canvas.getContext('2d');

        // Draw pink ECG paper background
        ctx.fillStyle = '#FFF4F4';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw grid (1mm = 4px at this scale, 5mm = 20px)
        const pxPerMm = 4;

        // Thin lines (1mm)
        ctx.strokeStyle = '#FFCCCC';
        ctx.lineWidth = 0.5;
        for (let x = 0; x < canvas.width; x += pxPerMm) {
          if (x % (pxPerMm * 5) !== 0) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
          }
        }
        for (let y = 0; y < canvas.height; y += pxPerMm) {
          if (y % (pxPerMm * 5) !== 0) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
          }
        }

        // Thick lines (5mm)
        ctx.strokeStyle = '#FF9999';
        ctx.lineWidth = 1;
        for (let x = 0; x < canvas.width; x += pxPerMm * 5) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += pxPerMm * 5) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }

        // Draw 12-lead layout (3 rows x 4 columns)
        const leads = ['I', 'aVR', 'V1', 'V4', 'II', 'aVL', 'V2', 'V5', 'III', 'aVF', 'V3', 'V6'];
        const panelWidth = (canvas.width - 80) / 4;
        const panelHeight = (canvas.height - 100) / 3;

        ctx.fillStyle = '#000000';
        ctx.font = 'bold 14px Arial';

        // Draw waveforms for each lead
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 1.5;

        leads.forEach((lead, idx) => {
          const col = idx % 4;
          const row = Math.floor(idx / 4);
          const startX = 40 + col * panelWidth;
          const baselineY = 50 + row * panelHeight + panelHeight / 2;

          // Draw lead label
          ctx.fillText(lead, startX + 5, baselineY - panelHeight / 2 + 20);

          // Draw ECG waveform
          ctx.beginPath();
          const samplesPerPanel = panelWidth;

          for (let i = 0; i < samplesPerPanel; i++) {
            const x = startX + i;
            const t = i / samplesPerPanel;

            // Generate realistic ECG waveform
            let y = 0;

            // Repeat 2 beats per panel
            const beatPhase = (t * 2) % 1;

            // P wave (small bump at 10-15%)
            if (beatPhase > 0.08 && beatPhase < 0.15) {
              y = 15 * Math.sin((beatPhase - 0.08) / 0.07 * Math.PI);
            }
            // QRS complex (sharp spike at 20-28%)
            else if (beatPhase > 0.18 && beatPhase < 0.28) {
              const qrsT = (beatPhase - 0.18) / 0.10;
              if (qrsT < 0.2) y = -10 * (qrsT / 0.2);           // Q
              else if (qrsT < 0.5) y = -10 + 90 * ((qrsT - 0.2) / 0.3);  // R up
              else if (qrsT < 0.8) y = 80 - 100 * ((qrsT - 0.5) / 0.3);  // R down to S
              else y = -20 + 20 * ((qrsT - 0.8) / 0.2);         // S recovery
            }
            // T wave (broader bump at 40-55%)
            else if (beatPhase > 0.38 && beatPhase < 0.55) {
              y = 30 * Math.sin((beatPhase - 0.38) / 0.17 * Math.PI);
            }

            // Scale by pxPerMm (10mm/mV standard)
            y = y * 0.4;

            if (i === 0) ctx.moveTo(x, baselineY - y);
            else ctx.lineTo(x, baselineY - y);
          }
          ctx.stroke();
        });

        // Convert canvas to blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const file = new File([blob], 'synthetic-ecg.png', { type: 'image/png' });

        statusBar.textContent = 'Processing synthetic ECG...';

        // Trigger the file load handler
        const fakeEvent = { target: { files: [file] } };
        await window.loadECGFile(fakeEvent);

      } catch (error) {
        console.error('Error with sample ECG:', error);
        statusBar.textContent = 'Error: ' + error.message;
        setTimeout(() => { statusBar.textContent = originalStatus; }, 5000);
      }
    });

    document.getElementById('format-select').addEventListener('change', window.renderECG);
    document.getElementById('speed-select').addEventListener('change', () => {
      window.renderECG();
      updateCaliperSettings();
    });
    document.getElementById('gain-select').addEventListener('change', () => {
      window.renderECG();
      updateCaliperSettings();
    });

    // Initialize calipers after first render
    function initCalipers() {
      const canvas = document.getElementById('ecg-canvas');
      if (canvas && !calipers) {
        calipers = new CalipersManager(canvas);
        updateCaliperSettings();
      }
    }

    function updateCaliperSettings() {
      if (calipers) {
        const paperSpeed = parseInt(document.getElementById('speed-select').value);
        const gain = parseInt(document.getElementById('gain-select').value);
        calipers.setSettings(paperSpeed, gain, 96);
        calipers.updateSize();
        calipers.updateTransform(currentZoom);
      }
    }

    // Caliper button handlers
    document.getElementById('btn-calipers').addEventListener('click', () => {
      initCalipers();
      if (calipers) {
        if (calipers.isActiveMode()) {
          calipers.deactivate();
          document.getElementById('btn-calipers').classList.remove('active');
        } else {
          calipers.activate();
          document.getElementById('btn-calipers').classList.add('active');
        }
      }
    });

    document.getElementById('btn-amplitude').addEventListener('click', () => {
      initCalipers();
      if (calipers) {
        if (calipers.isActiveMode()) {
          calipers.deactivate();
          document.getElementById('btn-amplitude').classList.remove('active');
        } else {
          calipers.activate();
          document.getElementById('btn-amplitude').classList.add('active');
        }
      }
    });

    document.getElementById('btn-clear-calipers').addEventListener('click', () => {
      if (calipers) {
        calipers.clear();
        calipers.deactivate();
        document.getElementById('btn-calipers').classList.remove('active');
        document.getElementById('btn-amplitude').classList.remove('active');
      }
    });

    document.getElementById('btn-annotations').addEventListener('click', () => {
      toggleAnnotations();
    });

    // ========== MENU SYSTEM ==========
    let openMenu = null;

    // Close all menus
    function closeAllMenus() {
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('open'));
      openMenu = null;
    }

    // Menu item click handlers
    document.querySelectorAll('.menu-item').forEach(menuItem => {
      menuItem.addEventListener('click', (e) => {
        if (e.target.classList.contains('dropdown-item')) return;

        const isOpen = menuItem.classList.contains('open');
        closeAllMenus();

        if (!isOpen) {
          menuItem.classList.add('open');
          openMenu = menuItem;
        }
      });

      // Hover to switch menus when one is open
      menuItem.addEventListener('mouseenter', () => {
        if (openMenu && openMenu !== menuItem) {
          closeAllMenus();
          menuItem.classList.add('open');
          openMenu = menuItem;
        }
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.menu-item')) {
        closeAllMenus();
      }
    });

    // Dropdown item click handlers
    document.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (item.classList.contains('disabled')) {
          e.stopPropagation();
          return;
        }

        const action = item.dataset.action;
        if (action) {
          handleMenuAction(action);
        }
        closeAllMenus();
      });
    });

    // Menu action handler
    function handleMenuAction(action) {
      switch (action) {
        // System/Go/List menus
        case 'edit-list':
        case 'go-back':
          showEditList();
          break;
        case 'go-next':
        case 'go-prev':
          alert('Navigate to next/previous ECG in the edit list.');
          break;
        case 'refresh-list':
          alert('Refreshing ECG list...');
          break;
        case 'my-inbasket':
        case 'peds-physician':
        case 'recent-edits':
          alert(`Switching to ${action} preset...`);
          break;
        // File menu
        case 'open':
          document.getElementById('file-input').click();
          break;
        case 'save':
          saveECG();
          break;
        case 'save-as':
          saveECGAs();
          break;
        case 'print':
          showPrintPreview();
          break;
        case 'export-pdf':
          exportPDF();
          break;
        case 'exit':
          if (confirm('Are you sure you want to exit?')) {
            window.close();
          }
          break;

        // Edit menu
        case 'undo':
          alert('Nothing to undo.');
          break;
        case 'redo':
          alert('Nothing to redo.');
          break;
        case 'cut':
        case 'copy':
        case 'paste':
          alert('Clipboard operations are not available in this demo.');
          break;
        case 'select-all':
          alert('Select All: No selectable content.');
          break;
        case 'patient-info':
          showPatientInfoDialog();
          break;

        // View menu
        case 'zoom-in':
          window.zoomIn();
          break;
        case 'zoom-out':
          window.zoomOut();
          break;
        case 'fit-window':
          fitToWindow();
          break;
        case 'toggle-grid':
          toggleGrid();
          break;
        case 'toggle-annotations':
          toggleAnnotations();
          // Update menu checkmark
          const annotItem = document.querySelector('[data-action="toggle-annotations"]');
          if (annotItem) {
            const checkmark = annotItem.querySelector('.checkmark');
            if (checkmark) checkmark.textContent = showAnnotations ? '‚úì' : '';
          }
          break;
        case 'format-12':
          document.getElementById('format-select').value = '12';
          window.renderECG();
          updateViewMenuChecks();
          break;
        case 'format-15':
          document.getElementById('format-select').value = '15';
          window.renderECG();
          updateViewMenuChecks();
          break;
        case 'speed-25':
          document.getElementById('speed-select').value = '25';
          window.renderECG();
          updateCaliperSettings();
          updateViewMenuChecks();
          break;
        case 'speed-50':
          document.getElementById('speed-select').value = '50';
          window.renderECG();
          updateCaliperSettings();
          updateViewMenuChecks();
          break;
        case 'gain-5':
          document.getElementById('gain-select').value = '5';
          window.renderECG();
          updateCaliperSettings();
          updateViewMenuChecks();
          break;
        case 'gain-10':
          document.getElementById('gain-select').value = '10';
          window.renderECG();
          updateCaliperSettings();
          updateViewMenuChecks();
          break;
        case 'gain-20':
          document.getElementById('gain-select').value = '20';
          window.renderECG();
          updateCaliperSettings();
          updateViewMenuChecks();
          break;

        // ECG menu
        case 'acquire-ecg':
          alert('ECG acquisition would connect to hardware.\nFor demo, use File > Open to load an ECG file.');
          break;
        case 'analyze':
          alert('ECG analysis complete.\nInterpretation has been updated.');
          break;
        case 'confirm-interp':
          confirmInterpretation();
          break;
        case 'reject-interp':
          rejectInterpretation();
          break;
        case 'edit-interp':
          editInterpretation();
          break;
        case 'measurements-tab':
          document.querySelector('[data-tab="measurements"]').click();
          break;
        case 'compare-ecgs':
          showCompareDialog();
          break;

        // Reports menu
        case 'report-standard':
        case 'report-detailed':
        case 'report-summary':
        case 'report-custom':
          generateReport(action.replace('report-', ''));
          break;
        case 'patient-history':
          document.querySelector('[data-tab="history"]').click();
          break;

        // Tools menu
        case 'tool-calipers':
          document.getElementById('btn-calipers').click();
          break;
        case 'tool-amplitude':
          document.getElementById('btn-amplitude').click();
          break;
        case 'clear-measurements':
          document.getElementById('btn-clear-calipers').click();
          break;
        case 'tool-zoom-region':
          activateZoomRegion();
          break;
        case 'tool-pan':
          activatePan();
          break;
        case 'settings':
          showSettings();
          break;

        // Window menu
        case 'win-cascade':
          alert('Windows cascaded.\n(Single window demo)');
          break;
        case 'win-tile-h':
          alert('Windows tiled horizontally.\n(Single window demo)');
          break;
        case 'win-tile-v':
          alert('Windows tiled vertically.\n(Single window demo)');
          break;
        case 'win-minimize':
          alert('All windows minimized.\n(Single window demo)');
          break;
        case 'win-maximize':
          // Actually maximize if possible
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else {
            alert('Window maximized.');
          }
          break;
        case 'win-close':
          if (confirm('Close this window?')) {
            window.close();
          }
          break;

        // Help menu
        case 'help-contents':
        case 'user-guide':
        case 'quick-start':
          showHelp(action);
          break;
        case 'about':
          showAbout();
          break;
      }
    }

    // ========== HELPER FUNCTIONS ==========

    function newECG() {
      if (confirm('Create a new ECG record? Current data will be cleared.')) {
        currentSignal = null;
        currentPatient = null;
        currentMeasurements = null;
        ecgId = `ECG-${Date.now()}`;
        window.renderECG();
      }
    }

    function saveECG() {
      const data = {
        ecgId,
        patient: currentPatient,
        measurements: currentMeasurements,
        signal: currentSignal ? {
          sampleRate: currentSignal.sampleRate,
          duration: currentSignal.duration
        } : null,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem('peds_ecg_' + ecgId, JSON.stringify(data));
      alert('ECG saved to local storage.\nID: ' + ecgId);
    }

    function saveECGAs() {
      const newId = prompt('Enter ECG ID:', ecgId);
      if (newId) {
        ecgId = newId;
        saveECG();
      }
    }

    function getSavedECGList() {
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('peds_ecg_')) {
          keys.push(key.replace('peds_ecg_', ''));
        }
      }
      return keys.sort();
    }

    function loadSavedECG(id) {
      const data = localStorage.getItem('peds_ecg_' + id);
      if (!data) {
        alert('ECG not found: ' + id);
        return;
      }
      try {
        const parsed = JSON.parse(data);
        ecgId = parsed.ecgId || id;
        currentPatient = parsed.patient;
        currentMeasurements = parsed.measurements;
        // Note: Signal data is not fully saved in demo, so we keep sample ECG
        window.renderECG();
        alert('Loaded ECG: ' + ecgId);
      } catch (e) {
        alert('Error loading ECG: ' + e.message);
      }
    }

    function exportPDF() {
      // Create MUSE-style PDF using jsPDF
      const patient = currentPatient || {
        name: 'DOE, JANE',
        mrn: '12345678',
        age: '3 Years',
        sex: 'F',
        location: 'Peds Cardiology',
        testDateTime: new Date().toLocaleString(),
        interpretation: ['Normal sinus rhythm', 'Normal ECG for age'],
      };

      const measurements = currentMeasurements || {
        hr: 130, pr: 110, qrs: 72, qt: 320, qtc: 410,
        pAxis: 65, qrsAxis: 80, tAxis: 56,
      };

      // Create PDF in landscape Letter size
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'letter'
      });

      const pageWidth = 279.4; // Letter width in mm
      const pageHeight = 215.9; // Letter height in mm
      const margin = 5;

      // Colors
      const headerColor = [0, 51, 102]; // Navy blue
      const textColor = [0, 0, 0];
      const redColor = [200, 0, 0];

      // ========== HEADER SECTION ==========
      pdf.setFillColor(255, 255, 255);
      pdf.rect(0, 0, pageWidth, pageHeight, 'F');

      // Institution name
      pdf.setFontSize(14);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...headerColor);
      pdf.text('GEMUSE ECG Management System', margin, 8);

      // Patient demographics line 1
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...textColor);
      const line1 = `Patient: ${patient.name}    ID: ${patient.mrn}    Age: ${patient.age}    Sex: ${patient.sex}`;
      pdf.text(line1, margin, 14);

      // Patient demographics line 2
      const line2 = `Location: ${patient.location}    Test Date/Time: ${patient.testDateTime}`;
      pdf.text(line2, margin, 19);

      // Measurements box (right side of header) - MUSE style
      pdf.setFontSize(8);
      const measX = pageWidth - 90;
      const measCol2 = measX + 45;

      pdf.text(`Vent rate:`, measX, 10);
      pdf.text(`${measurements.hr} bpm`, measX + 20, 10);

      pdf.text(`PR interval:`, measX, 14);
      pdf.text(`${measurements.pr} ms`, measX + 20, 14);

      pdf.text(`QRS duration:`, measX, 18);
      pdf.text(`${measurements.qrs} ms`, measX + 23, 18);

      pdf.text(`QT/QTc:`, measCol2, 10);
      pdf.text(`${measurements.qt}/${measurements.qtc} ms`, measCol2 + 15, 10);

      pdf.text(`P-R-T axes:`, measCol2, 14);
      pdf.text(`${measurements.pAxis}¬∞ ${measurements.qrsAxis}¬∞ ${measurements.tAxis}¬∞`, measCol2 + 18, 14);

      const rr = measurements.rr || Math.round(60000 / measurements.hr);
      pdf.text(`RR interval:`, measCol2, 18);
      pdf.text(`${rr} ms`, measCol2 + 20, 18);

      // ========== INTERPRETATION SECTION ==========
      pdf.setDrawColor(0, 0, 0);
      pdf.setLineWidth(0.3);
      pdf.rect(margin, 22, pageWidth - 2 * margin, 18);

      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Interpretation:', margin + 2, 26);

      pdf.setFont('helvetica', 'normal');
      let interpY = 30;

      // Build interpretation lines from ZZU diagnosis or patient interpretation
      let interpretation = [];
      if (currentDiagnosis) {
        // Add ECG statements (filter out ICD-10 lines)
        const statements = currentDiagnosis.statements?.filter(s => !s.startsWith('ICD-10:')) || [];
        interpretation = interpretation.concat(statements);

        // Add AHA codes with descriptions
        if (currentDiagnosis.aha?.length > 0) {
          currentDiagnosis.aha.forEach(code => {
            const desc = getAHADescription(code);
            interpretation.push(desc !== code ? `${desc} (${code})` : code);
          });
        }

        // Add ICD-10 codes with descriptions
        if (currentDiagnosis.icd10?.length > 0) {
          currentDiagnosis.icd10.slice(0, 2).forEach(code => { // Limit to 2
            const desc = getICD10Description(code);
            interpretation.push(desc !== code ? `${desc} (${code})` : `ICD-10: ${code}`);
          });
        }
      } else {
        interpretation = patient.interpretation || ['Normal sinus rhythm'];
      }

      // Add age group context if available
      if (currentPediatricContext) {
        interpretation.unshift(`Age Group: ${currentPediatricContext.ageGroup.label}`);
      }

      interpretation.forEach((line, i) => {
        if (i < 5) { // Max 5 lines
          pdf.text(line, margin + 2, interpY);
          interpY += 4;
        }
      });

      // ========== ECG GRID SECTION ==========
      const ecgCanvas = document.getElementById('ecg-canvas');
      const ecgY = 42;
      const ecgHeight = pageHeight - ecgY - 15; // Leave room for footer
      const ecgWidth = pageWidth - 2 * margin;

      // Add the ECG canvas as image
      try {
        const imgData = ecgCanvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', margin, ecgY, ecgWidth, ecgHeight);
      } catch (e) {
        console.error('Error adding ECG image to PDF:', e);
        // Draw placeholder
        pdf.setDrawColor(200, 0, 0);
        pdf.rect(margin, ecgY, ecgWidth, ecgHeight);
        pdf.text('ECG Image', margin + 5, ecgY + 10);
      }

      // ========== FOOTER SECTION ==========
      const footerY = pageHeight - 8;
      pdf.setFontSize(8);
      pdf.setTextColor(...textColor);

      const paperSpeed = document.getElementById('speed-select').value;
      const gain = document.getElementById('gain-select').value;
      const format = document.getElementById('format-select').value === '15' ? '15-Lead' : '12-Lead';

      pdf.text(`${paperSpeed} mm/s  ${gain} mm/mV  ${format}  QTc: Bazett`, margin, footerY);
      pdf.text(`EID: ${ecgId}`, pageWidth / 2 - 15, footerY);

      // Confirmation status (right side)
      const confirmStatus = document.getElementById('confirm-status')?.textContent || 'UNCONFIRMED';
      const isConfirmed = confirmStatus === 'CONFIRMED';

      if (isConfirmed) {
        pdf.setTextColor(0, 128, 0); // Green for confirmed
        pdf.setFont('helvetica', 'bold');
        pdf.text('CONFIRMED', pageWidth - margin - 25, footerY);

        // Show confirming physician if available
        const physician = document.getElementById('confirm-physician')?.textContent;
        const confirmTime = document.getElementById('confirm-datetime')?.textContent;
        if (physician && physician !== '--') {
          pdf.setTextColor(...textColor);
          pdf.setFont('helvetica', 'normal');
          pdf.setFontSize(7);
          pdf.text(`Confirmed by: ${physician}`, pageWidth - margin - 60, footerY + 3);
          if (confirmTime) {
            pdf.text(`on ${confirmTime}`, pageWidth - margin - 60, footerY + 6);
          }
        }
      } else {
        pdf.setTextColor(...redColor);
        pdf.setFont('helvetica', 'bold');
        pdf.text(confirmStatus, pageWidth - margin - 30, footerY);
      }

      // Exported timestamp
      pdf.setTextColor(...textColor);
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(7);
      pdf.text(`Printed: ${new Date().toLocaleString()}`, margin, footerY + 4);

      // Add disclaimer for ZZU ECGs
      if (currentDiagnosis || currentPediatricContext) {
        pdf.setTextColor(...redColor);
        pdf.setFontSize(6);
        pdf.text('FOR EDUCATIONAL PURPOSES ONLY - NOT FOR CLINICAL USE', pageWidth / 2 - 40, footerY + 7);
        pdf.text('ZZU pECG Dataset - Zhengzhou University First Affiliated Hospital', pageWidth / 2 - 45, footerY + 10);
      }

      // ========== SAVE PDF ==========
      const filename = `ECG-${patient.mrn}-${Date.now()}.pdf`;
      pdf.save(filename);

      console.log('PDF exported:', filename);
    }

    function fitToWindow() {
      const container = document.getElementById('ecg-canvas-container');
      const canvas = document.getElementById('ecg-canvas');
      const scaleX = container.clientWidth / canvas.width;
      const scaleY = container.clientHeight / canvas.height;
      currentZoom = Math.min(scaleX, scaleY, 1);
      canvas.style.transform = `scale(${currentZoom})`;
      if (calipers) calipers.updateTransform(currentZoom);
    }

    function toggleGrid() {
      showGrid = !showGrid;
      window.renderECG();

      // Update menu checkmark
      const gridItem = document.querySelector('[data-action="toggle-grid"]');
      if (gridItem) {
        const checkmark = gridItem.querySelector('.checkmark');
        if (checkmark) {
          checkmark.textContent = showGrid ? '‚úì' : '';
        }
      }

      // Update toolbar button
      document.getElementById('btn-grid').classList.toggle('active', showGrid);
    }

    function updateViewMenuChecks() {
      const format = document.getElementById('format-select').value;
      const speed = document.getElementById('speed-select').value;
      const gain = document.getElementById('gain-select').value;

      // Clear all checkmarks first
      document.querySelectorAll('[data-action^="format-"], [data-action^="speed-"], [data-action^="gain-"]').forEach(item => {
        const checkmark = item.querySelector('.checkmark');
        if (checkmark) checkmark.textContent = '';
      });

      // Set correct checkmarks
      const formatItem = document.querySelector(`[data-action="format-${format}"]`);
      const speedItem = document.querySelector(`[data-action="speed-${speed}"]`);
      const gainItem = document.querySelector(`[data-action="gain-${gain}"]`);

      if (formatItem) {
        let cm = formatItem.querySelector('.checkmark');
        if (!cm) { cm = document.createElement('span'); cm.className = 'checkmark'; formatItem.prepend(cm); }
        cm.textContent = '‚úì';
      }
      if (speedItem) {
        let cm = speedItem.querySelector('.checkmark');
        if (!cm) { cm = document.createElement('span'); cm.className = 'checkmark'; speedItem.prepend(cm); }
        cm.textContent = '‚úì';
      }
      if (gainItem) {
        let cm = gainItem.querySelector('.checkmark');
        if (!cm) { cm = document.createElement('span'); cm.className = 'checkmark'; gainItem.prepend(cm); }
        cm.textContent = '‚úì';
      }
    }

    // ========== ECG CONFIRM/SIGN WORKFLOW ==========

    // Store confirmation state per ECG
    const ecgConfirmationState = {};

    function showConfirmDialog() {
      // Reset form
      document.getElementById('confirm-physician-name').value = '';
      document.getElementById('confirm-physician-id').value = '';
      document.getElementById('confirm-password').value = '';
      document.getElementById('confirm-agree').checked = false;
      openModal('confirm-dialog');
    }
    window.showConfirmDialog = showConfirmDialog;

    function confirmECG() {
      const name = document.getElementById('confirm-physician-name').value.trim();
      const id = document.getElementById('confirm-physician-id').value.trim();
      const password = document.getElementById('confirm-password').value;
      const agreed = document.getElementById('confirm-agree').checked;

      // Validate inputs
      if (!name) {
        alert('Please enter your physician name.');
        document.getElementById('confirm-physician-name').focus();
        return;
      }
      if (!id) {
        alert('Please enter your physician ID.');
        document.getElementById('confirm-physician-id').focus();
        return;
      }
      if (!password) {
        alert('Please enter your password.');
        document.getElementById('confirm-password').focus();
        return;
      }
      if (!agreed) {
        alert('You must confirm that the interpretation is accurate.');
        return;
      }

      // In a real system, password would be verified against authentication server
      // For demo purposes, we'll accept any non-empty password

      const confirmTime = new Date();
      const confirmData = {
        physician: name,
        physicianId: id,
        timestamp: confirmTime.toISOString(),
        displayTime: confirmTime.toLocaleString()
      };

      // Store confirmation state
      const currentECGId = ecgId || 'current';
      ecgConfirmationState[currentECGId] = confirmData;

      // Update UI
      const badge = document.getElementById('confirm-status');
      badge.textContent = 'CONFIRMED';
      badge.className = 'badge badge-confirmed';
      badge.title = `Confirmed by ${name} on ${confirmData.displayTime}`;

      // Show confirmation details
      document.getElementById('confirm-details').style.display = 'block';
      document.getElementById('confirm-physician').textContent = `${name} (${id})`;
      document.getElementById('confirm-datetime').textContent = confirmData.displayTime;

      // Update patient object if exists
      if (currentPatient) {
        currentPatient.confirmed = true;
        currentPatient.confirmedBy = name;
        currentPatient.confirmedAt = confirmData.displayTime;
      }

      closeModal('confirm-dialog');
    }
    window.confirmECG = confirmECG;

    function rejectECGDialog() {
      const reason = prompt('Please enter the reason for rejection:');
      if (reason === null) return; // Cancelled

      const badge = document.getElementById('confirm-status');
      badge.textContent = 'REJECTED';
      badge.className = 'badge badge-unconfirmed';
      badge.title = reason ? `Rejected: ${reason}` : 'Rejected by physician';

      // Store rejection state
      const currentECGId = ecgId || 'current';
      ecgConfirmationState[currentECGId] = {
        status: 'rejected',
        reason: reason,
        timestamp: new Date().toISOString()
      };

      // Hide confirmation details
      document.getElementById('confirm-details').style.display = 'none';

      if (currentPatient) {
        currentPatient.confirmed = false;
        currentPatient.rejectedReason = reason;
      }

      closeModal('confirm-dialog');
    }
    window.rejectECGDialog = rejectECGDialog;

    function toggleConfirmation() {
      const badge = document.getElementById('confirm-status');
      const currentECGId = ecgId || 'current';
      const state = ecgConfirmationState[currentECGId];

      if (badge.textContent === 'CONFIRMED') {
        // Unconfirm - require confirmation
        if (confirm('Remove confirmation from this ECG?')) {
          badge.textContent = 'UNCONFIRMED';
          badge.className = 'badge badge-unconfirmed';
          badge.title = 'Click to confirm/unconfirm';
          document.getElementById('confirm-details').style.display = 'none';
          delete ecgConfirmationState[currentECGId];
          if (currentPatient) {
            currentPatient.confirmed = false;
          }
        }
      } else if (badge.textContent === 'UNCONFIRMED' || badge.textContent === 'EDITED') {
        // Show full confirmation dialog
        showConfirmDialog();
      } else if (badge.textContent === 'REJECTED') {
        // Show dialog to reconsider
        if (confirm('This ECG was previously rejected. Do you want to confirm it now?')) {
          showConfirmDialog();
        }
      }
    }
    window.toggleConfirmation = toggleConfirmation;

    function resetConfirmationUI(ecgIdToCheck) {
      const badge = document.getElementById('confirm-status');
      const details = document.getElementById('confirm-details');

      // Check if this ECG has saved confirmation state
      const state = ecgConfirmationState[ecgIdToCheck];
      if (state && state.physician) {
        // Restore confirmed state
        badge.textContent = 'CONFIRMED';
        badge.className = 'badge badge-confirmed';
        badge.title = `Confirmed by ${state.physician} on ${state.displayTime}`;
        details.style.display = 'block';
        document.getElementById('confirm-physician').textContent = `${state.physician} (${state.physicianId})`;
        document.getElementById('confirm-datetime').textContent = state.displayTime;
      } else if (state && state.status === 'rejected') {
        // Restore rejected state
        badge.textContent = 'REJECTED';
        badge.className = 'badge badge-unconfirmed';
        badge.title = state.reason ? `Rejected: ${state.reason}` : 'Rejected by physician';
        details.style.display = 'none';
      } else {
        // Reset to unconfirmed
        badge.textContent = 'UNCONFIRMED';
        badge.className = 'badge badge-unconfirmed';
        badge.title = 'Click to confirm/unconfirm';
        details.style.display = 'none';
      }
    }

    // Legacy function names for menu compatibility
    function confirmInterpretation() {
      showConfirmDialog();
    }

    function rejectInterpretation() {
      rejectECGDialog();
    }

    function editInterpretation() {
      const interpContainer = document.getElementById('ecg-interpretation-text');
      const currentText = Array.from(interpContainer.querySelectorAll('.interp-line'))
        .map(el => el.textContent).join('\n');

      const newText = prompt('Edit interpretation (one line per finding):', currentText);
      if (newText !== null) {
        const lines = newText.split('\n').filter(l => l.trim());
        interpContainer.innerHTML = lines.map(line =>
          `<div class="interp-line">${line}</div>`
        ).join('');

        const badge = document.getElementById('confirm-status');
        badge.textContent = 'EDITED';
        badge.className = 'badge badge-unconfirmed';
      }
    }

    function generateReport(type) {
      alert(`Generating ${type} report...\n\nPatient: ${currentPatient?.name || 'DOE, JANE'}\nECG ID: ${ecgId}\n\n(Report would be generated and displayed)`);
    }

    // ========== MODAL DIALOG SYSTEM ==========

    window.openModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        // Focus on first input
        const firstInput = modal.querySelector('input, select, textarea');
        if (firstInput) firstInput.focus();
      }
    };

    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
      }
    };

    // Close modal when clicking overlay (not the dialog itself)
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Settings dialog tab switching
    document.querySelectorAll('[data-settings-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.settingsTab;

        // Update tab buttons
        document.querySelectorAll('[data-settings-tab]').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update tab content
        document.querySelectorAll('#settings-modal .dialog-tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById('settings-' + tabName).classList.add('active');
      });
    });

    function showPatientInfoDialog() {
      // Populate form with current patient data
      const patient = currentPatient || {
        mrn: '12345678',
        name: 'DOE, JANE',
        dob: '03/15/2021',
        age: '3 yr',
        sex: 'F',
        race: '---',
        location: 'Peds Cardiology Clinic',
        room: 'Exam 4',
        referredBy: 'Smith, John MD',
        technician: 'Johnson, Mary RT',
        notes: ''
      };

      const nameParts = (patient.name || 'DOE, JANE').split(', ');
      const lastName = nameParts[0] || '';
      const firstName = nameParts[1] || '';

      document.getElementById('edit-patient-id').value = patient.mrn || '';
      document.getElementById('edit-patient-last').value = lastName;
      document.getElementById('edit-patient-first').value = firstName;
      document.getElementById('edit-patient-dob').value = patient.dob || '';
      document.getElementById('edit-patient-age').value = patient.age || '';
      document.getElementById('edit-patient-sex').value = patient.sex || 'U';
      document.getElementById('edit-patient-race').value = patient.race || '';
      document.getElementById('edit-patient-location').value = patient.location || '';
      document.getElementById('edit-patient-room').value = patient.room || '';
      document.getElementById('edit-patient-referred').value = patient.referredBy || '';
      document.getElementById('edit-patient-tech').value = patient.technician || '';
      document.getElementById('edit-patient-notes').value = patient.notes || '';

      openModal('patient-modal');
    }

    window.savePatientInfo = function() {
      const lastName = document.getElementById('edit-patient-last').value.trim();
      const firstName = document.getElementById('edit-patient-first').value.trim();

      currentPatient = currentPatient || {};
      currentPatient.mrn = document.getElementById('edit-patient-id').value.trim();
      currentPatient.name = lastName + (firstName ? ', ' + firstName : '');
      currentPatient.dob = document.getElementById('edit-patient-dob').value.trim();
      currentPatient.age = document.getElementById('edit-patient-age').value.trim();
      currentPatient.sex = document.getElementById('edit-patient-sex').value;
      currentPatient.race = document.getElementById('edit-patient-race').value.trim();
      currentPatient.location = document.getElementById('edit-patient-location').value.trim();
      currentPatient.room = document.getElementById('edit-patient-room').value.trim();
      currentPatient.referredBy = document.getElementById('edit-patient-referred').value.trim();
      currentPatient.technician = document.getElementById('edit-patient-tech').value.trim();
      currentPatient.notes = document.getElementById('edit-patient-notes').value.trim();

      closeModal('patient-modal');
      window.renderECG();
    };

    function showSettings() {
      // Populate settings from current values
      document.getElementById('settings-format').value = document.getElementById('format-select').value;
      document.getElementById('settings-speed').value = document.getElementById('speed-select').value;
      document.getElementById('settings-gain').value = document.getElementById('gain-select').value;
      document.getElementById('settings-show-grid').checked = showGrid;

      openModal('settings-modal');
    }

    window.applySettings = function() {
      // Apply display settings
      document.getElementById('format-select').value = document.getElementById('settings-format').value;
      document.getElementById('speed-select').value = document.getElementById('settings-speed').value;
      document.getElementById('gain-select').value = document.getElementById('settings-gain').value;

      const newShowGrid = document.getElementById('settings-show-grid').checked;
      if (newShowGrid !== showGrid) {
        showGrid = newShowGrid;
        document.getElementById('btn-grid').classList.toggle('active', showGrid);
      }

      window.renderECG();
      updateCaliperSettings();
      updateViewMenuChecks();

      closeModal('settings-modal');
    };

    function showHelp(topic) {
      const topics = {
        'help-contents': 'GEMUSE Help Contents\n\nThis is a demo of the MUSE ECG Management System.\n\nFor help, see the User Guide.',
        'user-guide': 'GEMUSE User Guide\n\n1. Open an ECG file using File > Open\n2. View different leads using the tabs\n3. Use calipers to measure intervals\n4. Print or export using File menu',
        'quick-start': 'Quick Start Tutorial\n\n1. Click File > Open to load an ECG\n2. Select 12-Lead or 15-Lead format\n3. Adjust paper speed and gain as needed\n4. Use the Calipers tool to measure\n5. Print or save when done'
      };
      alert(topics[topic] || 'Help topic not found.');
    }

    window.showChangeLog = function() {
      alert('Change Log\n\nNo changes recorded for this ECG.\n\nThe change log tracks all edits made to patient demographics, interpretation, and measurements.');
    };

    // ========== VIEW SWITCHING ==========

    window.selectECGRow = function(row) {
      // Deselect all rows
      document.querySelectorAll('.edit-list-table tbody tr').forEach(r => r.classList.remove('selected'));
      // Select clicked row
      row.classList.add('selected');
    };

    // Programmatic double-click handler for table rows (backup for inline handlers)
    document.getElementById('edit-list-tbody').addEventListener('dblclick', (e) => {
      const row = e.target.closest('tr');
      if (row) {
        const ecgId = row.getAttribute('data-ecg-id');
        if (ecgId) {
          openECG(ecgId);
        }
      }
    });

    window.openECG = function(openedEcgId) {
      // Update ecgId (local variable in module scope)
      ecgId = openedEcgId;

      // Get the selected row data
      const row = document.querySelector(`tr[data-ecg-id="${openedEcgId}"]`);
      if (row) {
        const cells = row.querySelectorAll('td');
        const patientName = cells[1].textContent;
        const patientId = cells[0].textContent;
        const age = cells[2].textContent;

        // Update title bar
        document.getElementById('title-patient').textContent = patientName;
        document.getElementById('title-datetime').textContent = cells[3].textContent;

        // Update patient info in ECG viewer
        document.getElementById('patient-id').value = patientId;
        document.getElementById('patient-name').value = patientName;

        // Update status bar
        document.getElementById('status-id').textContent = patientId;
      }

      // Reset/restore confirmation state for this ECG
      resetConfirmationUI(openedEcgId);

      // Switch to ECG viewer
      showECGViewer();
      window.renderECG();
    };

    window.showEditList = function() {
      document.getElementById('view-edit-list').style.display = 'flex';
      document.getElementById('view-ecg-viewer').style.display = 'none';
      document.querySelector('.title-bar-text').innerHTML = 'MUSE‚Ñ¢ System - Edit/Retrieve: Site:1 User:2095';
    };

    window.showECGViewer = function() {
      document.getElementById('view-edit-list').style.display = 'none';
      document.getElementById('view-ecg-viewer').style.display = 'flex';
      const patientName = document.getElementById('patient-name').value || 'DOE, JANE';
      const datetime = new Date().toLocaleString();
      document.querySelector('.title-bar-text').innerHTML = `MUSE - ECG Management System - <span id="title-patient">${patientName}</span> - <span id="title-datetime">${datetime}</span>`;
    };

    window.searchECGs = function() {
      const patientId = document.getElementById('search-patient-id').value.trim().toLowerCase();
      const lastName = document.getElementById('search-last-name').value.trim().toLowerCase();
      const firstName = document.getElementById('search-first-name').value.trim().toLowerCase();
      const orderNum = document.getElementById('search-order').value.trim().toLowerCase();

      const rows = document.querySelectorAll('.edit-list-table tbody tr');
      let matchCount = 0;

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 4) return;

        const rowPatientId = cells[0].textContent.toLowerCase();
        const rowName = cells[1].textContent.toLowerCase();
        const rowDate = cells[3].textContent.toLowerCase();

        // Parse name (format: "LAST, FIRST")
        const nameParts = rowName.split(',');
        const rowLastName = nameParts[0]?.trim() || '';
        const rowFirstName = nameParts[1]?.trim() || '';

        // Check if row matches all non-empty search criteria
        let matches = true;

        if (patientId && !rowPatientId.includes(patientId)) {
          matches = false;
        }
        if (lastName && !rowLastName.includes(lastName)) {
          matches = false;
        }
        if (firstName && !rowFirstName.includes(firstName)) {
          matches = false;
        }
        if (orderNum && !rowPatientId.includes(orderNum)) {
          matches = false;
        }

        // Show/hide row based on match
        if (matches) {
          row.style.display = '';
          matchCount++;
        } else {
          row.style.display = 'none';
        }
      });

      // Update status bar with result count
      const statusText = matchCount === rows.length
        ? `Showing all ${matchCount} ECGs`
        : `Found ${matchCount} of ${rows.length} ECGs`;

      // Show message if no results
      if (matchCount === 0) {
        alert('No ECGs found matching the search criteria.');
      }
    };

    window.clearSearch = function() {
      // Clear all search inputs
      document.getElementById('search-patient-id').value = '';
      document.getElementById('search-last-name').value = '';
      document.getElementById('search-first-name').value = '';
      document.getElementById('search-order').value = '';

      // Show all rows
      const rows = document.querySelectorAll('.edit-list-table tbody tr');
      rows.forEach(row => {
        row.style.display = '';
      });
    };

    // Enter key in search fields triggers search
    ['search-patient-id', 'search-last-name', 'search-first-name', 'search-order'].forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchECGs();
          }
        });
      }
    });

    // Add menu item for Edit List
    document.querySelector('[data-action="new-ecg"]')?.addEventListener('click', () => {
      showEditList();
    });

    function showAbout() {
      // Update system info
      const sysInfo = document.getElementById('about-system-info');
      sysInfo.innerHTML = `
        Browser: ${navigator.userAgent.split(' ').slice(-2).join(' ')}<br>
        Platform: ${navigator.platform}<br>
        Screen: ${window.screen.width} x ${window.screen.height}<br>
        Color Depth: ${window.screen.colorDepth}-bit<br>
        Language: ${navigator.language}<br>
        Memory: ${navigator.deviceMemory ? navigator.deviceMemory + ' GB' : 'N/A'}
      `;

      openModal('about-modal');
    }

    window.showSystemInfo = function() {
      const info = `
System Information:

Browser: ${navigator.userAgent}
Platform: ${navigator.platform}
Screen Resolution: ${window.screen.width} x ${window.screen.height}
Available Screen: ${window.screen.availWidth} x ${window.screen.availHeight}
Color Depth: ${window.screen.colorDepth}-bit
Pixel Ratio: ${window.devicePixelRatio}
Language: ${navigator.language}
Cookies Enabled: ${navigator.cookieEnabled}
Online: ${navigator.onLine}
Memory: ${navigator.deviceMemory ? navigator.deviceMemory + ' GB' : 'Not available'}
CPU Cores: ${navigator.hardwareConcurrency || 'Not available'}

GEMUSE Information:
Version: 1.0.0
Build: 2025.12.20
Canvas Support: ${!!document.createElement('canvas').getContext}
LocalStorage: ${typeof localStorage !== 'undefined' ? 'Available' : 'Not available'}
      `.trim();

      alert(info);
    };

    // ========== PRINT PREVIEW ==========

    function showPrintPreview() {
      openModal('print-preview-modal');
      renderPrintPreview();
    }

    function renderPrintPreview() {
      const previewCanvas = document.getElementById('preview-canvas');
      const ecgCanvas = document.getElementById('ecg-canvas');

      // Copy the ECG canvas to preview canvas
      previewCanvas.width = ecgCanvas.width;
      previewCanvas.height = ecgCanvas.height;
      previewCanvas.style.width = '100%';
      previewCanvas.style.height = 'auto';

      const ctx = previewCanvas.getContext('2d');
      ctx.drawImage(ecgCanvas, 0, 0);
    }

    window.updatePreviewZoom = function() {
      const zoom = parseFloat(document.getElementById('preview-zoom').value);
      const page = document.getElementById('print-preview-page');
      page.style.transform = `scale(${zoom})`;
    };

    window.doPrint = function() {
      closeModal('print-preview-modal');
      setTimeout(() => window.print(), 100);
    };

    // ========== ECG COMPARISON ==========

    let comparisonSignal = null;
    let comparisonPatient = null;

    function showCompareDialog() {
      const patient = currentPatient || { name: 'DOE, JANE', testDateTime: new Date().toLocaleString() };
      document.getElementById('compare-current-name').textContent = patient.name;
      document.getElementById('compare-current-date').textContent = patient.testDateTime;

      if (comparisonSignal) {
        document.getElementById('compare-loaded-name').textContent = comparisonPatient?.name || 'Loaded ECG';
      } else {
        document.getElementById('compare-loaded-name').textContent = 'No ECG loaded';
      }

      openModal('compare-modal');
      renderComparisonView();
    }
    window.showCompareDialog = showCompareDialog;

    function renderComparisonView() {
      const canvas = document.getElementById('compare-canvas');
      const ctx = canvas.getContext('2d');
      const container = document.getElementById('compare-canvas-container');

      const mode = document.querySelector('input[name="compare-mode"]:checked')?.value || 'side-by-side';
      const leadName = document.getElementById('compare-lead').value || 'II';

      const signal1 = currentSignal || sampleECG;
      const signal2 = comparisonSignal;

      const width = mode === 'side-by-side' ? 1200 : 700;
      const height = 350;

      canvas.width = width;
      canvas.height = height;

      // Clear and draw background
      ctx.fillStyle = ECG_COLORS.background;
      ctx.fillRect(0, 0, width, height);

      // Draw grid
      const dpi = 96;
      const pxPerMm = dpi / 25.4;
      const smallBoxPx = pxPerMm * 1;
      const largeBoxPx = pxPerMm * 5;

      // Draw thin grid lines
      ctx.strokeStyle = ECG_COLORS.thinLine;
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      for (let x = 0; x <= width; x += smallBoxPx) {
        if (Math.round(x / smallBoxPx) % 5 !== 0) {
          ctx.moveTo(Math.round(x) + 0.5, 0);
          ctx.lineTo(Math.round(x) + 0.5, height);
        }
      }
      for (let y = 0; y <= height; y += smallBoxPx) {
        if (Math.round(y / smallBoxPx) % 5 !== 0) {
          ctx.moveTo(0, Math.round(y) + 0.5);
          ctx.lineTo(width, Math.round(y) + 0.5);
        }
      }
      ctx.stroke();

      // Draw thick grid lines
      ctx.strokeStyle = ECG_COLORS.thickLine;
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let x = 0; x <= width; x += largeBoxPx) {
        ctx.moveTo(Math.round(x) + 0.5, 0);
        ctx.lineTo(Math.round(x) + 0.5, height);
      }
      for (let y = 0; y <= height; y += largeBoxPx) {
        ctx.moveTo(0, Math.round(y) + 0.5);
        ctx.lineTo(width, Math.round(y) + 0.5);
      }
      ctx.stroke();

      const paperSpeed = 25;
      const gain = 10;
      const pxPerSecond = pxPerMm * paperSpeed;

      if (mode === 'side-by-side') {
        // Side by side view
        const halfWidth = width / 2;
        const baselineY1 = height / 2;
        const baselineY2 = height / 2;

        // Draw dividing line
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(halfWidth, 0);
        ctx.lineTo(halfWidth, height);
        ctx.stroke();

        // Draw current ECG (left side)
        const samples1 = signal1.leads[leadName] || [];
        if (samples1.length > 0) {
          const pxPerSample1 = pxPerSecond / signal1.sampleRate;
          const pxPerUv1 = pxPerMm * (gain / 1000);
          renderComparisonWaveform(ctx, samples1, 10, baselineY1, pxPerSample1, pxPerUv1, halfWidth - 20, '#000000', 'Current');
        }

        // Draw comparison ECG (right side)
        if (signal2) {
          const samples2 = signal2.leads[leadName] || [];
          if (samples2.length > 0) {
            const pxPerSample2 = pxPerSecond / signal2.sampleRate;
            const pxPerUv2 = pxPerMm * (gain / 1000);
            renderComparisonWaveform(ctx, samples2, halfWidth + 10, baselineY2, pxPerSample2, pxPerUv2, halfWidth - 20, '#0066CC', 'Comparison');
          }
        } else {
          ctx.font = '12px Arial';
          ctx.fillStyle = '#666';
          ctx.textAlign = 'center';
          ctx.fillText('Load comparison ECG to compare', halfWidth + halfWidth / 2, height / 2);
        }

      } else {
        // Overlay view
        const baselineY = height / 2;

        // Draw current ECG (black)
        const samples1 = signal1.leads[leadName] || [];
        if (samples1.length > 0) {
          const pxPerSample1 = pxPerSecond / signal1.sampleRate;
          const pxPerUv1 = pxPerMm * (gain / 1000);
          renderComparisonWaveform(ctx, samples1, 10, baselineY, pxPerSample1, pxPerUv1, width - 20, '#000000', 'Current (black)');
        }

        // Draw comparison ECG (blue, semi-transparent)
        if (signal2) {
          const samples2 = signal2.leads[leadName] || [];
          if (samples2.length > 0) {
            const pxPerSample2 = pxPerSecond / signal2.sampleRate;
            const pxPerUv2 = pxPerMm * (gain / 1000);
            ctx.globalAlpha = 0.7;
            renderComparisonWaveform(ctx, samples2, 10, baselineY, pxPerSample2, pxPerUv2, width - 20, '#0066CC', 'Comparison (blue)');
            ctx.globalAlpha = 1.0;
          }
        }

        // Legend
        ctx.font = 'bold 10px Arial';
        ctx.textAlign = 'left';
        ctx.fillStyle = '#000000';
        ctx.fillText('Current (black)', 10, 15);
        ctx.fillStyle = '#0066CC';
        ctx.fillText('Comparison (blue)', 100, 15);
      }

      // Update measurements display
      updateComparisonMeasurements(leadName, signal1, signal2);
    }

    function renderComparisonWaveform(ctx, samples, startX, baselineY, pxPerSample, pxPerUv, maxWidth, color, label) {
      if (!samples || samples.length === 0) return;

      const mean = samples.reduce((sum, v) => sum + v, 0) / samples.length;

      ctx.strokeStyle = color;
      ctx.lineWidth = 1.25;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();

      let first = true;
      for (let i = 0; i < samples.length; i++) {
        const x = startX + i * pxPerSample;
        if (x > startX + maxWidth) break;
        const y = baselineY - (samples[i] - mean) * pxPerUv;

        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();
    }

    function updateComparisonMeasurements(leadName, signal1, signal2) {
      const meas1 = currentMeasurements || { hr: 75, qrs: 80 };
      const meas2 = comparisonPatient?.measurements || null;

      const currentEl = document.getElementById('compare-meas-current');
      const compareEl = document.getElementById('compare-meas-compare');
      const diffEl = document.getElementById('compare-meas-diff');

      currentEl.textContent = `HR: ${meas1.hr} bpm, QRS: ${meas1.qrs} ms`;

      if (meas2) {
        compareEl.textContent = `HR: ${meas2.hr} bpm, QRS: ${meas2.qrs} ms`;
        const hrDiff = meas1.hr - meas2.hr;
        const qrsDiff = meas1.qrs - meas2.qrs;
        diffEl.textContent = `HR: ${hrDiff > 0 ? '+' : ''}${hrDiff} bpm, QRS: ${qrsDiff > 0 ? '+' : ''}${qrsDiff} ms`;
      } else {
        compareEl.textContent = '--';
        diffEl.textContent = '--';
      }
    }

    // Set up comparison file input
    document.getElementById('compare-file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const result = parseMuseXML(text);

        comparisonSignal = result.signal;
        comparisonPatient = {
          name: `${result.patient.lastName}, ${result.patient.firstName}`,
          testDateTime: `${result.test.acquisitionDate} ${result.test.acquisitionTime}`,
          measurements: { hr: 75, qrs: 80, pr: 160 }, // Would need to parse from signal
        };

        document.getElementById('compare-loaded-name').textContent = comparisonPatient.name;
        renderComparisonView();
      } catch (error) {
        alert('Error loading comparison ECG: ' + error.message);
      }
    });

    document.getElementById('btn-load-compare').addEventListener('click', () => {
      document.getElementById('compare-file-input').click();
    });

    // Re-render on mode or lead change
    document.querySelectorAll('input[name="compare-mode"]').forEach(radio => {
      radio.addEventListener('change', renderComparisonView);
    });
    document.getElementById('compare-lead').addEventListener('change', renderComparisonView);

    // ========== SERIAL PRESENTATION ==========

    // ECG history for the current patient
    let serialECGHistory = [];

    function addDemoSerialECGs() {
      // Generate some demo serial ECGs with different dates
      const baseSignal = currentSignal || sampleECG;
      const patient = currentPatient || { name: 'DOE, JANE', mrn: '12345678' };

      // Create 4 demo ECGs at different dates
      const now = new Date();
      serialECGHistory = [
        {
          id: 'ecg-current',
          date: now,
          dateStr: now.toLocaleDateString(),
          signal: baseSignal,
          interpretation: ['Normal sinus rhythm', 'Normal ECG for age'],
          hr: 130,
          isCurrent: true
        },
        {
          id: 'ecg-1month',
          date: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000),
          dateStr: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
          signal: baseSignal,
          interpretation: ['Sinus tachycardia', 'Otherwise normal ECG'],
          hr: 145
        },
        {
          id: 'ecg-3months',
          date: new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000),
          dateStr: new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toLocaleDateString(),
          signal: baseSignal,
          interpretation: ['Normal sinus rhythm', 'RVH pattern (borderline)'],
          hr: 128
        },
        {
          id: 'ecg-6months',
          date: new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000),
          dateStr: new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000).toLocaleDateString(),
          signal: baseSignal,
          interpretation: ['Sinus rhythm', 'Normal ECG'],
          hr: 125
        }
      ];

      document.getElementById('serial-patient-name').textContent = patient.name;
      renderSerialTimeline();
      renderSerialThumbnails();
    }
    window.addDemoSerialECGs = addDemoSerialECGs;

    function renderSerialTimeline() {
      const container = document.getElementById('serial-timeline');

      if (serialECGHistory.length === 0) {
        container.innerHTML = '<span style="color:#999;font-size:11px;">No previous ECGs in history</span>';
        return;
      }

      let html = '';
      serialECGHistory.forEach((ecg, idx) => {
        const isSelected = idx === 0;
        html += `
          <div class="serial-timeline-item ${isSelected ? 'selected' : ''}"
               onclick="selectSerialECG('${ecg.id}')"
               style="display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:5px 10px;
                      border-radius:4px;background:${isSelected ? '#3060A0' : '#e0e0e0'};
                      color:${isSelected ? '#fff' : '#000'};min-width:80px;">
            <span style="font-size:10px;font-weight:bold;">${ecg.isCurrent ? 'CURRENT' : ''}</span>
            <span style="font-size:11px;">${ecg.dateStr}</span>
            <span style="font-size:9px;">HR: ${ecg.hr} bpm</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderSerialThumbnails() {
      const container = document.getElementById('serial-thumbnails');

      if (serialECGHistory.length === 0) {
        container.innerHTML = `
          <div style="text-align:center;padding:40px;color:#666;font-size:12px;">
            Click "Load Demo ECGs" to see example serial ECGs,<br>
            or load MUSE XML files using File > Open.
          </div>
        `;
        return;
      }

      let html = '';
      serialECGHistory.forEach((ecg) => {
        html += `
          <div class="serial-thumbnail-card" onclick="selectSerialECG('${ecg.id}')"
               style="background:#fff;border:1px solid #999;padding:8px;cursor:pointer;
                      box-shadow:1px 1px 3px rgba(0,0,0,0.2);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
              <span style="font-weight:bold;font-size:11px;">${ecg.dateStr}</span>
              ${ecg.isCurrent ? '<span style="background:#3060A0;color:#fff;font-size:9px;padding:1px 4px;border-radius:2px;">CURRENT</span>' : ''}
            </div>
            <canvas id="thumb-${ecg.id}" width="260" height="80" style="background:#FFF4F4;border:1px solid #ddd;display:block;"></canvas>
            <div style="margin-top:5px;font-size:10px;">
              <div><b>HR:</b> ${ecg.hr} bpm</div>
              <div style="color:#666;font-size:9px;margin-top:2px;">${ecg.interpretation[0]}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // Render thumbnail waveforms
      setTimeout(() => {
        serialECGHistory.forEach((ecg) => {
          renderSerialThumbnail(ecg);
        });
      }, 100);
    }

    function renderSerialThumbnail(ecg) {
      const canvas = document.getElementById(`thumb-${ecg.id}`);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      // Draw background
      ctx.fillStyle = ECG_COLORS.background;
      ctx.fillRect(0, 0, width, height);

      // Draw simple grid
      const dpi = 96;
      const pxPerMm = dpi / 25.4;
      const largeBoxPx = pxPerMm * 5;

      ctx.strokeStyle = ECG_COLORS.thickLine;
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      for (let x = 0; x <= width; x += largeBoxPx) {
        ctx.moveTo(Math.round(x) + 0.5, 0);
        ctx.lineTo(Math.round(x) + 0.5, height);
      }
      for (let y = 0; y <= height; y += largeBoxPx) {
        ctx.moveTo(0, Math.round(y) + 0.5);
        ctx.lineTo(width, Math.round(y) + 0.5);
      }
      ctx.stroke();

      // Draw lead II waveform
      const samples = ecg.signal?.leads?.['II'] || [];
      if (samples.length === 0) return;

      const paperSpeed = 25;
      const gain = 10;
      const pxPerSecond = pxPerMm * paperSpeed;
      const pxPerSample = pxPerSecond / (ecg.signal?.sampleRate || 500);
      const pxPerUv = pxPerMm * (gain / 1000);

      const mean = samples.reduce((sum, v) => sum + v, 0) / samples.length;
      const baselineY = height / 2;

      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1;
      ctx.beginPath();

      let first = true;
      for (let i = 0; i < samples.length; i++) {
        const x = 5 + i * pxPerSample;
        if (x > width - 5) break;
        const y = baselineY - (samples[i] - mean) * pxPerUv;

        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      // Draw lead label
      ctx.font = 'bold 9px Arial';
      ctx.fillStyle = ECG_COLORS.leadLabel;
      ctx.fillText('II', 5, 12);
    }

    function selectSerialECG(ecgId) {
      const ecg = serialECGHistory.find(e => e.id === ecgId);
      if (!ecg) return;

      // Update timeline selection
      document.querySelectorAll('.serial-timeline-item').forEach(item => {
        item.style.background = '#e0e0e0';
        item.style.color = '#000';
      });

      const selectedItem = document.querySelector(`.serial-timeline-item[onclick*="${ecgId}"]`);
      if (selectedItem) {
        selectedItem.style.background = '#3060A0';
        selectedItem.style.color = '#fff';
      }

      // Show preview panel
      const previewPanel = document.getElementById('serial-preview-panel');
      previewPanel.style.display = 'block';
      document.getElementById('serial-preview-date').textContent = ecg.dateStr + ' - ' + ecg.interpretation[0];

      // Render preview
      renderSerialPreview(ecg);
    }
    window.selectSerialECG = selectSerialECG;

    function renderSerialPreview(ecg) {
      const canvas = document.getElementById('serial-preview-canvas');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');

      // Set canvas size based on container
      const container = canvas.parentElement;
      canvas.width = container.clientWidth - 20;
      canvas.height = 150;

      const width = canvas.width;
      const height = canvas.height;

      // Draw background
      ctx.fillStyle = ECG_COLORS.background;
      ctx.fillRect(0, 0, width, height);

      // Draw grid
      const dpi = 96;
      const pxPerMm = dpi / 25.4;
      const smallBoxPx = pxPerMm * 1;
      const largeBoxPx = pxPerMm * 5;

      ctx.strokeStyle = ECG_COLORS.thinLine;
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      for (let x = 0; x <= width; x += smallBoxPx) {
        if (Math.round(x / smallBoxPx) % 5 !== 0) {
          ctx.moveTo(Math.round(x) + 0.5, 0);
          ctx.lineTo(Math.round(x) + 0.5, height);
        }
      }
      for (let y = 0; y <= height; y += smallBoxPx) {
        if (Math.round(y / smallBoxPx) % 5 !== 0) {
          ctx.moveTo(0, Math.round(y) + 0.5);
          ctx.lineTo(width, Math.round(y) + 0.5);
        }
      }
      ctx.stroke();

      ctx.strokeStyle = ECG_COLORS.thickLine;
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let x = 0; x <= width; x += largeBoxPx) {
        ctx.moveTo(Math.round(x) + 0.5, 0);
        ctx.lineTo(Math.round(x) + 0.5, height);
      }
      for (let y = 0; y <= height; y += largeBoxPx) {
        ctx.moveTo(0, Math.round(y) + 0.5);
        ctx.lineTo(width, Math.round(y) + 0.5);
      }
      ctx.stroke();

      // Draw lead II waveform
      const samples = ecg.signal?.leads?.['II'] || [];
      if (samples.length === 0) return;

      const paperSpeed = 25;
      const gain = 10;
      const pxPerSecond = pxPerMm * paperSpeed;
      const pxPerSample = pxPerSecond / (ecg.signal?.sampleRate || 500);
      const pxPerUv = pxPerMm * (gain / 1000);

      const mean = samples.reduce((sum, v) => sum + v, 0) / samples.length;
      const baselineY = height / 2;

      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 1.25;
      ctx.beginPath();

      let first = true;
      for (let i = 0; i < samples.length; i++) {
        const x = 30 + i * pxPerSample;
        if (x > width - 10) break;
        const y = baselineY - (samples[i] - mean) * pxPerUv;

        if (first) {
          ctx.moveTo(x, y);
          first = false;
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      // Draw lead label
      ctx.font = 'bold 10px Arial';
      ctx.fillStyle = ECG_COLORS.leadLabel;
      ctx.fillText('II', 10, 15);
    }

    // ========== ECG TOOLS ==========

    function clearToolState() {
      currentTool = null;
      isPanning = false;
      document.getElementById('btn-zoom-region').classList.remove('active');
      document.getElementById('btn-pan').classList.remove('active');
      const container = document.getElementById('ecg-canvas-container');
      container.style.cursor = 'default';
    }

    function activateZoomRegion() {
      clearToolState();
      if (calipers) calipers.deactivate();
      document.getElementById('btn-calipers').classList.remove('active');
      document.getElementById('btn-amplitude').classList.remove('active');

      currentTool = 'zoom-region';
      document.getElementById('btn-zoom-region').classList.add('active');
      document.getElementById('ecg-canvas-container').style.cursor = 'zoom-in';
    }

    function activatePan() {
      clearToolState();
      if (calipers) calipers.deactivate();
      document.getElementById('btn-calipers').classList.remove('active');
      document.getElementById('btn-amplitude').classList.remove('active');

      currentTool = 'pan';
      document.getElementById('btn-pan').classList.add('active');
      document.getElementById('ecg-canvas-container').style.cursor = 'grab';
    }

    // Zoom Region button handler
    document.getElementById('btn-zoom-region').addEventListener('click', () => {
      if (currentTool === 'zoom-region') {
        clearToolState();
      } else {
        activateZoomRegion();
      }
    });

    // Pan button handler
    document.getElementById('btn-pan').addEventListener('click', () => {
      if (currentTool === 'pan') {
        clearToolState();
      } else {
        activatePan();
      }
    });

    // Grid toggle button handler
    document.getElementById('btn-grid').addEventListener('click', () => {
      toggleGrid();
    });

    // Pan and Zoom Region mouse events
    const canvasContainer = document.getElementById('ecg-canvas-container');

    canvasContainer.addEventListener('mousedown', (e) => {
      if (currentTool === 'pan') {
        isPanning = true;
        panStart = { x: e.clientX, y: e.clientY };
        scrollStart = { x: canvasContainer.scrollLeft, y: canvasContainer.scrollTop };
        canvasContainer.style.cursor = 'grabbing';
      } else if (currentTool === 'zoom-region') {
        // Simple click zoom for demo
        const rect = canvasContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left + canvasContainer.scrollLeft;
        const clickY = e.clientY - rect.top + canvasContainer.scrollTop;

        currentZoom = Math.min(currentZoom + 0.25, 3);
        document.getElementById('ecg-canvas').style.transform = `scale(${currentZoom})`;
        if (calipers) calipers.updateTransform(currentZoom);

        // Try to center on click point
        setTimeout(() => {
          canvasContainer.scrollLeft = clickX * currentZoom - canvasContainer.clientWidth / 2;
          canvasContainer.scrollTop = clickY * currentZoom - canvasContainer.clientHeight / 2;
        }, 10);
      }
    });

    canvasContainer.addEventListener('mousemove', (e) => {
      if (isPanning && currentTool === 'pan') {
        const dx = e.clientX - panStart.x;
        const dy = e.clientY - panStart.y;
        canvasContainer.scrollLeft = scrollStart.x - dx;
        canvasContainer.scrollTop = scrollStart.y - dy;
      }
    });

    canvasContainer.addEventListener('mouseup', () => {
      if (isPanning) {
        isPanning = false;
        if (currentTool === 'pan') {
          canvasContainer.style.cursor = 'grab';
        }
      }
    });

    canvasContainer.addEventListener('mouseleave', () => {
      if (isPanning) {
        isPanning = false;
        if (currentTool === 'pan') {
          canvasContainer.style.cursor = 'grab';
        }
      }
    });

    // Save button handler
    document.getElementById('btn-save').addEventListener('click', saveECG);

    // Prev/Next ECG handlers
    document.getElementById('btn-prev').addEventListener('click', () => {
      const savedECGs = getSavedECGList();
      if (savedECGs.length === 0) {
        alert('No saved ECGs available.\nUse File > Save to save the current ECG first.');
        return;
      }
      const currentIndex = savedECGs.indexOf(ecgId);
      const prevIndex = currentIndex > 0 ? currentIndex - 1 : savedECGs.length - 1;
      loadSavedECG(savedECGs[prevIndex]);
    });

    document.getElementById('btn-next').addEventListener('click', () => {
      const savedECGs = getSavedECGList();
      if (savedECGs.length === 0) {
        alert('No saved ECGs available.\nUse File > Save to save the current ECG first.');
        return;
      }
      const currentIndex = savedECGs.indexOf(ecgId);
      const nextIndex = currentIndex < savedECGs.length - 1 ? currentIndex + 1 : 0;
      loadSavedECG(savedECGs[nextIndex]);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // F1 for help
      if (e.key === 'F1') {
        e.preventDefault();
        showHelp('help-contents');
        return;
      }

      // Escape to close menus and deactivate tools
      if (e.key === 'Escape') {
        closeAllMenus();
        clearToolState();
        if (calipers) {
          calipers.deactivate();
          document.getElementById('btn-calipers').classList.remove('active');
          document.getElementById('btn-amplitude').classList.remove('active');
        }
        return;
      }

      // Enter key in Edit List opens selected ECG
      if (e.key === 'Enter') {
        const editListVisible = document.getElementById('view-edit-list').style.display !== 'none';
        if (editListVisible) {
          const selectedRow = document.querySelector('.edit-list-table tbody tr.selected');
          if (selectedRow) {
            const ecgId = selectedRow.getAttribute('data-ecg-id');
            if (ecgId) {
              e.preventDefault();
              openECG(ecgId);
            }
          }
        }
        return;
      }

      // F2 to go to Edit List
      if (e.key === 'F2') {
        e.preventDefault();
        showEditList();
        return;
      }

      // Arrow keys for navigation in Edit List
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        const editListVisible = document.getElementById('view-edit-list').style.display !== 'none';
        if (editListVisible) {
          e.preventDefault();
          const rows = Array.from(document.querySelectorAll('.edit-list-table tbody tr'));
          const selectedRow = document.querySelector('.edit-list-table tbody tr.selected');
          const currentIndex = selectedRow ? rows.indexOf(selectedRow) : -1;

          let newIndex;
          if (e.key === 'ArrowUp') {
            newIndex = currentIndex > 0 ? currentIndex - 1 : rows.length - 1;
          } else {
            newIndex = currentIndex < rows.length - 1 ? currentIndex + 1 : 0;
          }

          rows.forEach(r => r.classList.remove('selected'));
          rows[newIndex].classList.add('selected');
          rows[newIndex].scrollIntoView({ block: 'nearest' });
        }
        return;
      }

      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'n':
            e.preventDefault();
            newECG();
            break;
          case 'o':
            e.preventDefault();
            document.getElementById('file-input').click();
            break;
          case 's':
            e.preventDefault();
            saveECG();
            break;
          case 'p':
            e.preventDefault();
            window.print();
            break;
          case '=':
          case '+':
            e.preventDefault();
            window.zoomIn();
            break;
          case '-':
            e.preventDefault();
            window.zoomOut();
            break;
          case '0':
            e.preventDefault();
            fitToWindow();
            break;
          case 'g':
            e.preventDefault();
            toggleGrid();
            break;
        }
      }
    });

    // ========== ZZU pECG DATASET INTEGRATION ==========
    let zzuIndex = [];
    const ZZU_ECG_PATH = 'json_ecgs/';

    // Load ZZU pECG index and populate table
    async function loadZZUDataset() {
      try {
        const response = await fetch(ZZU_ECG_PATH + 'index.json');
        if (!response.ok) throw new Error('Failed to load ZZU index');
        zzuIndex = await response.json();
        populateZZUTable();

        // Update count display
        document.getElementById('edit-list-filter').textContent = 'ZZU pECG Dataset';
        document.querySelector('.edit-list-count').innerHTML =
          `<strong>${zzuIndex.length}</strong> Pediatric ECGs from ZZU pECG Dataset`;

        console.log(`Loaded ZZU pECG index: ${zzuIndex.length} ECGs`);
      } catch (e) {
        console.warn('ZZU dataset not available:', e.message);
      }
    }

    function populateZZUTable() {
      const tbody = document.getElementById('edit-list-tbody');
      if (!tbody || zzuIndex.length === 0) return;

      // Clear existing rows
      tbody.innerHTML = '';

      // Category display names and status
      const categoryNames = {
        'Normal': 'Normal ECG',
        'Sinus_Tachycardia': 'Sinus Tachycardia',
        'VSD': 'Ventricular Septal Defect',
        'ASD': 'Atrial Septal Defect',
        'Myocarditis': 'Myocarditis',
        'Kawasaki': 'Kawasaki Disease',
        'SVT': 'Supraventricular Tachycardia',
        'VT': 'Ventricular Tachycardia',
      };

      zzuIndex.forEach((ecg, idx) => {
        const row = document.createElement('tr');
        row.setAttribute('data-ecg-id', ecg.ecg_id);
        row.setAttribute('data-zzu-file', ecg.file);
        row.onclick = function() { selectECGRow(this); };
        row.ondblclick = function() { openZZUECG(ecg.ecg_id, ecg.file); };

        if (idx === 0) row.classList.add('selected');

        const diagnosis = categoryNames[ecg.category] || ecg.category;

        row.innerHTML = `
          <td>${ecg.patient_id}</td>
          <td>PATIENT, ${ecg.patient_id}</td>
          <td>${ecg.age}</td>
          <td>2021</td>
          <td>12-Lead ECG</td>
          <td>ZZU Cardiology</td>
          <td>${diagnosis}</td>
          <td>${ecg.ecg_id}</td>
          <td>ZZU First Affiliated Hospital</td>
        `;

        tbody.appendChild(row);
      });
    }

    // Load ZZU ECG JSON and display
    async function openZZUECG(ecgId, filename) {
      const statusBar = document.querySelector('.status-bar-right');
      const originalStatus = statusBar.textContent;

      try {
        statusBar.textContent = `Loading ECG: ${ecgId}...`;

        const response = await fetch(ZZU_ECG_PATH + filename);
        if (!response.ok) throw new Error('Failed to load ECG file');

        const ecgData = await response.json();

        // Convert signal format for GEMUSE renderer
        // ZZU JSON has leads in millivolts (mV), GEMUSE expects microvolts (¬µV)
        // Also normalize lead names (AVR -> aVR, etc.)
        const leads = {};
        const leadNameMap = { 'AVR': 'aVR', 'AVL': 'aVL', 'AVF': 'aVF' };
        for (const [leadName, samples] of Object.entries(ecgData.signal.leads)) {
          const normalizedName = leadNameMap[leadName] || leadName;
          // Convert mV to ¬µV (multiply by 1,000)
          leads[normalizedName] = samples.map(v => v * 1000);
        }

        currentSignal = {
          leads: leads,
          sampleRate: ecgData.signal.sampleRate,
          duration: ecgData.signal.duration,
          numSamples: ecgData.signal.numSamples,
        };

        // Set patient info
        const p = ecgData.patient;
        const ageDays = parseAgeToDays(p.age);
        currentPatient = {
          patientId: p.mrn || ecgId,
          mrn: p.mrn || ecgId,
          name: `PATIENT, ${p.mrn || ecgId}`,
          lastName: 'PATIENT',
          firstName: p.mrn || ecgId,
          age: p.age || `${parseAgeToYears(p.age)} Years`,
          ageDays: ageDays,  // Age in days for ML
          ageUnits: getAgeUnits(p.age),
          sex: p.sex || 'U',
          gender: p.sex || 'U',
          race: '',
          orderId: ecgId,
          technician: '',
          referredBy: '',
          location: p.location || 'ZZU Pediatric Cardiology',
          testDateTime: ecgData.patient.testDateTime || ecgData.test?.acquisitionDate || new Date().toLocaleString(),
          confirmed: false,
        };

        // Set diagnosis
        currentDiagnosis = ecgData.diagnosis;

        // Get pediatric context for age-appropriate interpretation
        currentPediatricContext = getPediatricContext(ecgData.patient.age);

        // Update UI
        ecgId = ecgId;
        document.getElementById('patient-id').value = currentPatient.patientId;
        document.getElementById('patient-name').value = `PATIENT, ${currentPatient.patientId}`;
        document.getElementById('title-patient').textContent = `PATIENT, ${currentPatient.patientId}`;
        document.getElementById('status-id').textContent = currentPatient.patientId;

        // Update interpretation display
        updateDiagnosisDisplay();

        // Reset measurements so they're recalculated from new signal
        currentMeasurements = null;

        showECGViewer();
        window.renderECG();

        // Run ML analysis
        analyzeWithML();

        statusBar.textContent = `Loaded: ${filename} (${Object.keys(leads).length} leads, ${currentSignal.sampleRate}Hz)`;

        console.log('Loaded ZZU ECG:', {
          ecgId,
          leads: Object.keys(leads).length,
          sampleRate: currentSignal.sampleRate,
          duration: currentSignal.duration,
          diagnosis: ecgData.diagnosis,
        });

      } catch (e) {
        console.error('Error loading ZZU ECG:', e);
        statusBar.textContent = 'Error: ' + e.message;
        setTimeout(() => { statusBar.textContent = originalStatus; }, 3000);
      }
    }

    // Parse ZZU age string to days (for GEMUSE age group lookup)
    function parseAgeToDays(ageStr) {
      if (!ageStr) return 0;
      const match = ageStr.match(/([\d.]+)\s*(yr|mo|days?|d)/i);
      if (!match) return 0;
      const value = parseFloat(match[1]);
      const unit = match[2].toLowerCase();
      if (unit.startsWith('yr') || unit === 'y') return ageToDays(value, 'years');
      if (unit.startsWith('mo') || unit === 'm') return ageToDays(value, 'months');
      if (unit.startsWith('day') || unit === 'd') return ageToDays(value, 'days');
      return Math.round(value * 365.25); // Default to years
    }

    function parseAgeToYears(ageStr) {
      const days = parseAgeToDays(ageStr);
      return Math.round(days / 365.25 * 10) / 10;
    }

    function getAgeUnits(ageStr) {
      if (!ageStr) return 'Years';
      if (/mo/i.test(ageStr)) return 'Months';
      if (/day/i.test(ageStr)) return 'Days';
      return 'Years';
    }

    let currentDiagnosis = null;
    let currentPediatricContext = null;

    // Get pediatric context for age
    function getPediatricContext(ageStr) {
      const ageDays = parseAgeToDays(ageStr);
      const ageGroup = getAgeGroup(ageDays);
      const normals = getNormalsForAge(ageDays);
      const clinicalNotes = getClinicalNotes(ageDays);

      return {
        ageDays,
        ageGroup,
        normals,
        clinicalNotes,
      };
    }

    // ICD-10 code descriptions (cardiac and relevant codes from ZZU dataset)
    const ICD10_DESCRIPTIONS = {
      // Congenital heart defects (Q20-Q28)
      'Q21.0': 'Ventricular septal defect (VSD)',
      'Q21.1': 'Atrial septal defect (ASD)',
      '(FO) Q21.1': 'Patent foramen ovale / ASD',
      '(F) Q21.1': 'Patent foramen ovale / ASD',
      'Q25.0': 'Patent ductus arteriosus (PDA)',
      'Q67.7': 'Pectus excavatum',
      // Acquired cardiac (I00-I99)
      'I07.1': 'Rheumatic tricuspid insufficiency',
      'I08.0': 'Rheumatic mitral and aortic valve disease',
      'I27.2': 'Pulmonary hypertension',
      'I34.0': 'Mitral valve insufficiency',
      'I40.0': 'Infective myocarditis',
      '(F) I40.0': 'Infective myocarditis',
      'I42.0': 'Dilated cardiomyopathy',
      'I47.1': 'Supraventricular tachycardia (SVT)',
      'I47.2': 'Ventricular tachycardia',
      'I49.3': 'Ventricular premature beats (PVCs)',
      'I49.9': 'Cardiac arrhythmia, unspecified',
      'I50.9': 'Heart failure, unspecified',
      'I51.4': 'Myocarditis, unspecified',
      'I51.7': 'Cardiomegaly',
      // Symptoms (R00-R99)
      'R42': 'Dizziness',
      'R55': 'Syncope',
      'R94.5': 'Abnormal ECG finding',
      // Kawasaki and inflammatory
      'M30.3': 'Kawasaki disease',
      // Other relevant
      'Z98.8': 'Post-procedural status',
      'D68.9': 'Coagulation defect',
      'E65': 'Obesity',
      'E04.1': 'Thyroid nodule',
      'E27.8': 'Adrenal disorder',
      'E28.1': 'Androgen excess',
      'E77.8': 'Glycoprotein metabolism disorder',
      'E83.5': 'Calcium metabolism disorder',
      'E87.6': 'Hypokalemia',
      'J03.9': 'Acute tonsillitis',
      'J06.9': 'Upper respiratory infection',
      'J18.9': 'Pneumonia',
      'J35.1': 'Tonsillar hypertrophy',
      'J35.2': 'Adenoid hypertrophy',
      'J92.9': 'Pleural plaque',
      'J94.8': 'Pleural condition',
      'J98.4': 'Lung disorder',
      'J98.8': 'Respiratory disorder',
      'K56.5': 'Intestinal adhesions',
      'K65.8': 'Peritonitis',
      'K92.9': 'GI disease',
      'L40.4': 'Psoriatic arthropathy',
      'L90.9': 'Skin atrophy',
      'C83.7': 'Burkitt lymphoma',
    };

    // AHA ECG interpretation codes
    const AHA_DESCRIPTIONS = {
      // Normal variants
      'A1': 'Normal ECG',
      'A2': 'Otherwise normal ECG',
      // Rate abnormalities
      'C21': 'Sinus tachycardia',
      'E55': 'Sinus bradycardia',
      // Rhythm abnormalities
      'G70': 'Atrial premature complexes',
      'H89': 'Ventricular premature complexes',
      'I104': 'First-degree AV block',
      'I105': 'Second-degree AV block',
      // Axis deviations
      'J120': 'Left axis deviation',
      // Conduction abnormalities
      'K140': 'Right bundle branch block (complete)',
      'K141': 'Right bundle branch block (incomplete)',
      'K142': 'Left bundle branch block (complete)',
      'K143': 'Left anterior fascicular block',
      // Hypertrophy
      'L145': 'Left atrial enlargement',
      'L145+Modifier362': 'Left atrial enlargement',
      'L146': 'Right atrial enlargement',
      'L147': 'Left ventricular hypertrophy (LVH)',
      'L147+Modifier367': 'LVH with repolarization abnormality',
      'L148': 'Right ventricular hypertrophy (RVH)',
      'Left ventricular high voltage': 'Left ventricular high voltage',
      'Abnormal precordial R-wave progression': 'Abnormal precordial R-wave progression',
      'Suggests207': 'Suggests prior MI',
    };

    function getICD10Description(code) {
      return ICD10_DESCRIPTIONS[code] || code;
    }

    function getAHADescription(code) {
      return AHA_DESCRIPTIONS[code] || code;
    }

    function updateDiagnosisDisplay() {
      // Update the main interpretation panel
      const interpPanel = document.getElementById('ecg-interpretation-text');
      const clericalInterp = document.getElementById('clerical-interp');

      let lines = [];

      // Add age group context if available
      if (currentPediatricContext) {
        const { ageGroup, normals } = currentPediatricContext;
        lines.push(`<strong>Age Group:</strong> ${ageGroup.label} (${ageGroup.stage})`);
        lines.push(`<strong>Normal HR:</strong> ${normals.heartRate.p2}-${normals.heartRate.p98} bpm (median ${normals.heartRate.p50})`);
        lines.push(`<strong>Normal QTc:</strong> ${normals.qtcBazett.p2}-${normals.qtcBazett.p98} ms`);
        lines.push(`<strong>Normal QRS Axis:</strong> ${normals.qrsAxis.p2}¬∞ to ${normals.qrsAxis.p98}¬∞`);
      }

      // Add existing diagnosis
      if (currentDiagnosis) {
        // ECG interpretation statements (filter out ICD-10 lines already in statements)
        if (currentDiagnosis.statements && currentDiagnosis.statements.length > 0) {
          lines.push(''); // spacer
          lines.push('<strong>ECG Interpretation:</strong>');
          currentDiagnosis.statements
            .filter(s => !s.startsWith('ICD-10:'))
            .forEach(s => lines.push(`‚Ä¢ ${s}`));
        }
        // AHA codes with descriptions
        if (currentDiagnosis.aha && currentDiagnosis.aha.length > 0) {
          lines.push('');
          lines.push('<strong>AHA Classification:</strong>');
          currentDiagnosis.aha.forEach(code => {
            const desc = getAHADescription(code);
            if (desc !== code) {
              lines.push(`‚Ä¢ ${desc} <span style="color:#666">(${code})</span>`);
            } else {
              lines.push(`‚Ä¢ ${code}`);
            }
          });
        }
        // ICD-10 codes with descriptions
        if (currentDiagnosis.icd10 && currentDiagnosis.icd10.length > 0) {
          lines.push('');
          lines.push('<strong>Clinical Diagnoses:</strong>');
          currentDiagnosis.icd10.forEach(code => {
            const desc = getICD10Description(code);
            if (desc !== code) {
              lines.push(`‚Ä¢ ${desc} <span style="color:#666">(${code})</span>`);
            } else {
              lines.push(`‚Ä¢ ${code}`);
            }
          });
        }
      }

      if (lines.length === 0) {
        lines = ['No interpretation available'];
      }

      // Update main ECG view interpretation
      if (interpPanel) {
        interpPanel.innerHTML = lines.map(s => `<div class="interp-line">${s}</div>`).join('');
      }

      // Update clerical tab interpretation with clinical notes
      if (clericalInterp) {
        let clericalHtml = '** ** ** ** * ZZU pECG Dataset * ** ** ** **<br>';
        clericalHtml += '<span style="color:#c00;font-size:10px;">For educational purposes only - not for clinical use</span><br><br>';

        if (currentPediatricContext) {
          clericalHtml += `<strong>Age Group:</strong> ${currentPediatricContext.ageGroup.label}<br>`;
          clericalHtml += `<strong>Clinical Notes:</strong> ${currentPediatricContext.clinicalNotes}<br><br>`;

          const n = currentPediatricContext.normals;
          clericalHtml += '<strong>Age-Specific Normal Ranges:</strong><br>';
          clericalHtml += `‚Ä¢ Heart Rate: ${n.heartRate.p2}-${n.heartRate.p98} bpm<br>`;
          clericalHtml += `‚Ä¢ PR Interval: ${n.prInterval.p2}-${n.prInterval.p98} ms<br>`;
          clericalHtml += `‚Ä¢ QRS Duration: ${n.qrsDuration.p2}-${n.qrsDuration.p98} ms<br>`;
          clericalHtml += `‚Ä¢ QTc (Bazett): ${n.qtcBazett.p2}-${n.qtcBazett.p98} ms<br>`;
          clericalHtml += `‚Ä¢ QRS Axis: ${n.qrsAxis.p2}¬∞ to ${n.qrsAxis.p98}¬∞<br>`;
          clericalHtml += `‚Ä¢ T-wave V1: ${n.tWaveV1.normal.join(' or ')} normal<br>`;
          if (n.tWaveV1.notes) {
            clericalHtml += `  <em>(${n.tWaveV1.notes})</em><br>`;
          }
          clericalHtml += '<br>';
        }

        if (currentDiagnosis) {
          // ECG Interpretation
          const ecgStatements = currentDiagnosis.statements?.filter(s => !s.startsWith('ICD-10:')) || [];
          if (ecgStatements.length > 0) {
            clericalHtml += '<strong>ECG Interpretation:</strong><br>';
            clericalHtml += ecgStatements.map(s => `‚Ä¢ ${s}`).join('<br>') + '<br><br>';
          }
          // AHA Classification
          if (currentDiagnosis.aha?.length > 0) {
            clericalHtml += '<strong>AHA Classification:</strong><br>';
            currentDiagnosis.aha.forEach(code => {
              const desc = getAHADescription(code);
              if (desc !== code) {
                clericalHtml += `‚Ä¢ ${desc} <span style="color:#666">(${code})</span><br>`;
              } else {
                clericalHtml += `‚Ä¢ ${code}<br>`;
              }
            });
            clericalHtml += '<br>';
          }
          // Clinical Diagnoses (ICD-10)
          if (currentDiagnosis.icd10?.length > 0) {
            clericalHtml += '<strong>Clinical Diagnoses (ICD-10):</strong><br>';
            currentDiagnosis.icd10.forEach(code => {
              const desc = getICD10Description(code);
              if (desc !== code) {
                clericalHtml += `‚Ä¢ ${desc} <span style="color:#666">(${code})</span><br>`;
              } else {
                clericalHtml += `‚Ä¢ ${code}<br>`;
              }
            });
          }
        }

        clericalInterp.innerHTML = clericalHtml;
      }
    }

    // Load ZZU dataset on startup
    loadZZUDataset();

    // Initial render
    window.renderECG();
  </script>
</body>
</html>
